import{a as K}from"./chunk-WKM2OYV4.js";import{a as Q}from"./chunk-RBWZAM2R.js";import{a as q}from"./chunk-RL5KOLBU.js";import{a as B,b as X,e as J,f as A}from"./chunk-PK5YRH4Z.js";import{a as W}from"./chunk-Q7Y4YLXA.js";import{$a as D,Da as j,M as w,Oa as b,Pa as v,R as m,Sa as M,Ta as S,Ua as $,Va as r,W as R,Wa as o,X as N,Xa as O,bb as F,ca as x,db as p,kb as L,lb as G,mb as H,nb as a,ob as E,pb as T,qa as i,qb as V,ub as Y}from"./chunk-LQHLUY7B.js";import{c as d}from"./chunk-2VMXMS7J.js";var I=class e{symptomRepo=m(X);mealRepo=m(B);settings=m(A);execute(){return d(this,arguments,function*(n={}){let l=(n.windowHours??this.settings.getSettings().correlationWindowHours)*36e5,u=n.minOccurrences??1,[y,ee]=yield Promise.all([this.symptomRepo.findAll(),this.mealRepo.findAll()]),P=new Map;for(let g of y){let s=K(g.timestamp-l),_=ee.filter(C=>C.timestamp>=s&&C.timestamp<=g.timestamp);for(let C of _)for(let{ingredient:h}of C.ingredients){let c=h.name.toLowerCase();P.has(c)||P.set(c,{category:h.category,fodmapLevel:h.fodmapLevel,symptoms:[],count:0});let f=P.get(c);f.count++,f.symptoms.push({type:g.symptomType,intensity:g.intensity})}}let z=[];for(let[g,s]of P.entries()){if(s.count<u)continue;let _=new Map;for(let c of s.symptoms)_.has(c.type)||_.set(c.type,[]),_.get(c.type).push(c.intensity);let C=Array.from(_.entries()).map(([c,f])=>({symptomType:c,averageIntensity:f.reduce((te,ne)=>te+ne,0)/f.length,count:f.length})),h=s.symptoms.length?s.symptoms.reduce((c,f)=>c+f.intensity,0)/s.symptoms.length:0;z.push({ingredientName:g,category:s.category,fodmapLevel:s.fodmapLevel,occurrences:s.count,associatedSymptoms:C,correlationScore:s.count*h})}return z.sort((g,s)=>s.correlationScore-g.correlationScore)})}static \u0275fac=function(t){return new(t||e)};static \u0275prov=w({token:e,factory:e.\u0275fac,providedIn:"root"})};var k=class e{aiText=m(J);settings=m(A);execute(n){return d(this,null,function*(){if(this.settings.getSettings().aiProvider==="none")throw new Error("Aucun provider IA configur\xE9.");let l=n.correlations.slice(0,10).map(y=>`- ${y.ingredientName}: score ${y.correlationScore.toFixed(1)}, ${y.occurrences} occurrence(s)`).join(`
`),u=`Tu es un assistant sp\xE9cialis\xE9 dans les troubles digestifs (SII/SIBO).
Voici les corr\xE9lations aliments-sympt\xF4mes d\xE9tect\xE9es sur les ${n.periodDays} derniers jours:
${l}
G\xE9n\xE8re une analyse narrative concise (3-5 paragraphes) en fran\xE7ais avec les aliments probl\xE9matiques, les patterns, des recommandations low-FODMAP, et une mise en garde m\xE9dicale.`;return this.aiText.generateText(u)})}static \u0275fac=function(t){return new(t||e)};static \u0275prov=w({token:e,factory:e.\u0275fac,providedIn:"root"})};var oe=(e,n)=>n.days,ie=(e,n)=>n.ingredientName,re=(e,n)=>n.symptomType;function ae(e,n){e&1&&O(0,"app-loading-spinner",3)}function se(e,n){if(e&1){let t=D();r(0,"button",13),F("click",function(){let u=R(t).$implicit,y=p(2);return N(y.setPeriod(u.days))}),a(1),o()}if(e&2){let t=n.$implicit,l=p(2);G("active",l.days()===t.days),i(),E(t.label)}}function ce(e,n){e&1&&O(0,"app-empty-state",8)}function le(e,n){if(e&1&&(r(0,"span"),a(1),o()),e&2){let t=p().$implicit;H(Y("fb fb--",t.fodmapLevel)),i(),T("FODMAP ",t.fodmapLevel)}}function me(e,n){if(e&1&&(r(0,"span",23),a(1),o()),e&2){let t=n.$implicit;i(),V("",t.symptomType," (",t.averageIntensity.toFixed(1),")")}}function de(e,n){if(e&1&&(r(0,"div",14)(1,"div",15)(2,"div",16)(3,"span",17),a(4),o(),b(5,le,2,4,"span",18),o(),r(6,"span",19),a(7),o()(),r(8,"div",20),O(9,"div",21),o(),r(10,"div",22)(11,"span"),a(12),o(),M(13,me,2,2,"span",23,re),o()()),e&2){let t=n.$implicit,l=p(3);i(4),E(t.ingredientName),i(),v(t.fodmapLevel&&t.fodmapLevel!=="unknown"?5:-1),i(2),T("Score ",t.correlationScore.toFixed(1)),i(2),L("width",l.barW(t),"%"),i(3),T("",t.occurrences," occ."),i(),S(t.associatedSymptoms.slice(0,3))}}function pe(e,n){if(e&1&&M(0,de,15,6,"div",14,ie),e&2){let t=p(2);S(t.corr().slice(0,10))}}function ge(e,n){e&1&&a(0,"En cours...")}function fe(e,n){e&1&&a(0,"G\xE9n\xE9rer")}function ue(e,n){if(e&1&&(r(0,"div",11)(1,"p"),a(2),o()()),e&2){let t=p(2);i(2),E(t.narrative())}}function ye(e,n){e&1&&(r(0,"p",12),a(1,'Cliquez "G\xE9n\xE9rer" pour une analyse IA (cl\xE9 API requise).'),o())}function _e(e,n){if(e&1){let t=D();r(0,"div",4),M(1,se,2,3,"button",5,oe),o(),r(3,"section",6)(4,"h2",7),a(5,"Aliments suspects"),o(),b(6,ce,1,0,"app-empty-state",8)(7,pe,2,0),o(),r(8,"section",6)(9,"div",9)(10,"h2",7),a(11,"Analyse narrative IA"),o(),r(12,"button",10),F("click",function(){R(t);let u=p();return N(u.genNarr())}),b(13,ge,1,0)(14,fe,1,0),o()(),b(15,ue,3,1,"div",11)(16,ye,2,0,"p",12),o()}if(e&2){let t=p();i(),S(t.periods),i(5),v(t.corr().length===0?6:7),i(6),$("disabled",t.genning()),i(),v(t.genning()?13:14),i(2),v(t.narrative()?15:16)}}var Z=class e{corrH=m(I);narrH=m(k);toast=m(W);loading=x(!0);corr=x([]);days=x(30);genning=x(!1);narrative=x(null);periods=[{days:7,label:"7 jours"},{days:14,label:"14 jours"},{days:30,label:"30 jours"}];ngOnInit(){return d(this,null,function*(){yield this.load()})}setPeriod(n){return d(this,null,function*(){this.days.set(n),yield this.load()})}barW(n){let t=this.corr()[0]?.correlationScore??1;return Math.round(n.correlationScore/t*100)}genNarr(){return d(this,null,function*(){this.genning.set(!0);try{this.narrative.set(yield this.narrH.execute({correlations:this.corr(),periodDays:this.days()}))}catch(n){this.toast.error(n.message??"Erreur IA")}finally{this.genning.set(!1)}})}load(){return d(this,null,function*(){this.loading.set(!0);try{this.corr.set(yield this.corrH.execute({windowHours:8}))}catch{this.toast.error("Erreur de calcul")}finally{this.loading.set(!1)}})}static \u0275fac=function(t){return new(t||e)};static \u0275cmp=j({type:e,selectors:[["app-analysis"]],decls:8,vars:1,consts:[[1,"page"],[1,"ph"],[1,"sub"],["message","Calcul..."],[1,"periods"],[1,"pb",3,"active"],[1,"section"],[1,"st"],["icon","\u{1F52C}","title","Pas assez de donn\xE9es","description","Enregistrez au moins 5 repas et sympt\xF4mes."],[1,"sh"],[1,"gen-btn",3,"click","disabled"],[1,"narr"],[1,"hint"],[1,"pb",3,"click"],[1,"card"],[1,"ch"],[1,"ci"],[1,"name"],[3,"class"],[1,"score"],[1,"bar"],[1,"bf"],[1,"meta"],[1,"st-tag"]],template:function(t,l){t&1&&(r(0,"div",0)(1,"header",1)(2,"h1"),a(3,"Analyse"),o(),r(4,"p",2),a(5,"Corr\xE9lations aliments\u2013sympt\xF4mes"),o()(),b(6,ae,1,0,"app-loading-spinner",3)(7,_e,17,4),o()),t&2&&(i(6),v(l.loading()?6:7))},dependencies:[q,Q],styles:[".page[_ngcontent-%COMP%]{padding:1rem;max-width:600px;margin:0 auto}.ph[_ngcontent-%COMP%]{margin-bottom:1rem}.ph[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{font-size:1.4rem;font-weight:700;margin:0}.sub[_ngcontent-%COMP%]{color:#888;font-size:.85rem;margin:.25rem 0 0}.periods[_ngcontent-%COMP%]{display:flex;gap:.4rem;margin-bottom:1.5rem}.pb[_ngcontent-%COMP%]{padding:.4rem .75rem;border-radius:20px;border:1.5px solid #ddd;background:#fff;cursor:pointer;font-size:.85rem}.pb.active[_ngcontent-%COMP%]{background:#e8f5e9;border-color:#2e7d32;color:#2e7d32;font-weight:600}.section[_ngcontent-%COMP%]{margin-bottom:2rem}.sh[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem}.st[_ngcontent-%COMP%]{font-size:1rem;font-weight:600;margin:0 0 .75rem}.card[_ngcontent-%COMP%]{background:#fff;border-radius:12px;padding:.85rem;border:1px solid #eee;margin-bottom:.75rem}.ch[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.5rem}.ci[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.25rem}.name[_ngcontent-%COMP%]{font-weight:600;font-size:.95rem;text-transform:capitalize}.fb[_ngcontent-%COMP%]{font-size:.7rem;padding:.15rem .4rem;border-radius:8px;width:fit-content;font-weight:600}.fb--low[_ngcontent-%COMP%]{background:#e8f5e9;color:#2e7d32}.fb--medium[_ngcontent-%COMP%]{background:#fff8e1;color:#f57f17}.fb--high[_ngcontent-%COMP%]{background:#ffebee;color:#c62828}.score[_ngcontent-%COMP%]{background:#fce4ec;color:#c62828;padding:.25rem .6rem;border-radius:10px;font-size:.8rem;font-weight:600;flex-shrink:0}.bar[_ngcontent-%COMP%]{height:4px;background:#f0f0f0;border-radius:4px;margin-bottom:.4rem}.bf[_ngcontent-%COMP%]{height:100%;background:#2e7d32;border-radius:4px}.meta[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:.35rem;font-size:.75rem;color:#888;align-items:center}.st-tag[_ngcontent-%COMP%]{background:#e8eaf6;color:#3949ab;padding:.15rem .4rem;border-radius:8px;font-weight:500}.gen-btn[_ngcontent-%COMP%]{padding:.4rem .85rem;border-radius:20px;border:none;background:#7b1fa2;color:#fff;font-size:.85rem;cursor:pointer;font-weight:600}.gen-btn[_ngcontent-%COMP%]:disabled{opacity:.6}.narr[_ngcontent-%COMP%]{background:#f3e5f5;border-radius:12px;padding:1rem}.narr[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:.9rem;line-height:1.6;margin:0;white-space:pre-wrap}.hint[_ngcontent-%COMP%]{font-size:.85rem;color:#888;font-style:italic}"]})};export{Z as AnalysisComponent};
