<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>GutTrack ‚Äî Journal digestif intelligent</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* ============================================================
   DESIGN TOKENS ‚Äî Angular-style CSS Variables
   ============================================================ */
:root {
  --sage:       #4a7c59;
  --sage-light: #6a9e78;
  --sage-pale:  #e8f2eb;
  --sage-faint: #f4f9f5;
  --amber:      #c8883a;
  --amber-pale: #fdf3e7;
  --coral:      #d4605a;
  --coral-pale: #fdeeed;
  --slate:      #2d3748;
  --slate-mid:  #4a5568;
  --slate-soft: #718096;
  --border:     #e2e8f0;
  --white:      #ffffff;
  --bg:         #f8faf9;
  --radius-sm:  8px;
  --radius-md:  14px;
  --radius-lg:  22px;
  --shadow-sm:  0 1px 4px rgba(45,55,72,.08);
  --shadow-md:  0 4px 16px rgba(45,55,72,.10);
  --shadow-lg:  0 12px 40px rgba(45,55,72,.13);
  --font-serif: 'DM Serif Display', Georgia, serif;
  --font-sans:  'DM Sans', system-ui, sans-serif;
  --nav-h:      64px;
  --bottom-h:   68px;
}

/* ============================================================
   RESET & BASE
   ============================================================ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 16px; -webkit-font-smoothing: antialiased; }
body {
  font-family: var(--font-sans);
  background: var(--bg);
  color: var(--slate);
  min-height: 100vh;
  overflow-x: hidden;
}
button { cursor: pointer; font-family: inherit; border: none; background: none; }
input, textarea, select { font-family: inherit; outline: none; }
a { text-decoration: none; color: inherit; }
img { display: block; max-width: 100%; }

/* ============================================================
   ANGULAR-STYLE ROUTER ‚Äî views managed via data-route
   ============================================================ */
.view { display: none; }
.view.active { display: block; animation: fadeIn .22s ease; }
@keyframes fadeIn { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }

/* ============================================================
   APP SHELL
   ============================================================ */
.app-header {
  position: fixed; top: 0; left: 0; right: 0; z-index: 100;
  height: var(--nav-h);
  background: rgba(255,255,255,.92);
  backdrop-filter: blur(14px);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 20px;
}
.app-logo {
  display: flex; align-items: center; gap: 10px;
}
.app-logo-icon {
  width: 36px; height: 36px;
  background: linear-gradient(135deg, var(--sage), var(--sage-light));
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px;
  box-shadow: 0 2px 8px rgba(74,124,89,.3);
}
.app-logo-text { font-family: var(--font-serif); font-size: 1.35rem; color: var(--slate); }
.app-logo-text span { color: var(--sage); }

.header-actions { display: flex; gap: 8px; }
.btn-icon {
  width: 38px; height: 38px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px;
  background: var(--sage-faint);
  color: var(--sage);
  transition: background .18s;
}
.btn-icon:hover { background: var(--sage-pale); }

.app-main {
  padding-top: calc(var(--nav-h) + 16px);
  padding-bottom: calc(var(--bottom-h) + 16px);
  min-height: 100vh;
}

/* Bottom nav */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
  height: var(--bottom-h);
  background: rgba(255,255,255,.95);
  backdrop-filter: blur(14px);
  border-top: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-around;
  padding: 0 8px 6px;
}
.nav-item {
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  padding: 8px 16px;
  border-radius: var(--radius-md);
  transition: background .18s;
  cursor: pointer;
}
.nav-item:hover { background: var(--sage-faint); }
.nav-item.active { background: var(--sage-pale); }
.nav-item .nav-icon { font-size: 22px; line-height: 1; }
.nav-item .nav-label {
  font-size: .68rem; font-weight: 500; letter-spacing: .01em;
  color: var(--slate-soft);
  transition: color .18s;
}
.nav-item.active .nav-label { color: var(--sage); }

/* ============================================================
   SHARED COMPONENTS
   ============================================================ */
.section-header {
  padding: 20px 20px 8px;
  display: flex; align-items: baseline; justify-content: space-between;
}
.section-title { font-family: var(--font-serif); font-size: 1.5rem; color: var(--slate); }
.section-sub { font-size: .8rem; color: var(--slate-soft); margin-top: 2px; }
.section-link { font-size: .82rem; color: var(--sage); font-weight: 500; }

.card {
  background: var(--white);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border);
  overflow: hidden;
  margin: 0 16px 16px;
}
.card-body { padding: 18px; }

.pill {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 4px 11px;
  border-radius: 100px;
  font-size: .74rem; font-weight: 500;
}
.pill-sage  { background: var(--sage-pale);  color: var(--sage); }
.pill-amber { background: var(--amber-pale); color: var(--amber); }
.pill-coral { background: var(--coral-pale); color: var(--coral); }

.btn-primary {
  background: var(--sage);
  color: white;
  padding: 13px 24px;
  border-radius: var(--radius-md);
  font-weight: 600; font-size: .92rem;
  transition: background .18s, transform .12s, box-shadow .18s;
  display: inline-flex; align-items: center; gap: 8px;
  box-shadow: 0 3px 12px rgba(74,124,89,.25);
}
.btn-primary:hover { background: var(--sage-light); box-shadow: 0 5px 18px rgba(74,124,89,.3); transform: translateY(-1px); }
.btn-primary:active { transform: translateY(0); }

.btn-secondary {
  background: var(--sage-faint);
  color: var(--sage);
  padding: 11px 20px;
  border-radius: var(--radius-md);
  font-weight: 500; font-size: .88rem;
  transition: background .18s;
  display: inline-flex; align-items: center; gap: 7px;
}
.btn-secondary:hover { background: var(--sage-pale); }

.btn-outline {
  background: transparent;
  border: 1.5px solid var(--border);
  color: var(--slate-mid);
  padding: 10px 18px;
  border-radius: var(--radius-md);
  font-weight: 500; font-size: .86rem;
  transition: border-color .18s, color .18s;
  display: inline-flex; align-items: center; gap: 7px;
}
.btn-outline:hover { border-color: var(--sage); color: var(--sage); }

/* Form inputs */
.form-group { margin-bottom: 16px; }
.form-label { display: block; font-size: .83rem; font-weight: 500; color: var(--slate-mid); margin-bottom: 6px; }
.form-control {
  width: 100%;
  padding: 11px 14px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-md);
  font-size: .9rem; color: var(--slate);
  background: var(--white);
  transition: border-color .18s;
}
.form-control:focus { border-color: var(--sage); }
.form-textarea { resize: vertical; min-height: 80px; }
select.form-control { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23718096' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 14px center; padding-right: 36px; }

/* Score slider */
.score-row { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 6px; }
.score-btn {
  width: 40px; height: 40px;
  border-radius: 10px;
  font-weight: 600; font-size: .92rem;
  border: 1.5px solid var(--border);
  color: var(--slate-soft);
  transition: all .15s;
}
.score-btn:hover { border-color: var(--sage); color: var(--sage); background: var(--sage-faint); }
.score-btn.selected { background: var(--sage); border-color: var(--sage); color: white; }
.score-btn.sel-amber { background: var(--amber); border-color: var(--amber); color: white; }
.score-btn.sel-coral { background: var(--coral); border-color: var(--coral); color: white; }

/* ============================================================
   VIEW : DASHBOARD
   ============================================================ */
.dashboard-greeting {
  padding: 20px 20px 0;
}
.greeting-date { font-size: .8rem; color: var(--slate-soft); text-transform: uppercase; letter-spacing: .05em; }
.greeting-title { font-family: var(--font-serif); font-size: 1.8rem; line-height: 1.2; margin-top: 4px; }
.greeting-title em { color: var(--sage); font-style: italic; }

.stats-row {
  display: grid; grid-template-columns: repeat(3, 1fr);
  gap: 10px; padding: 18px 16px 0;
}
.stat-card {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 14px 12px;
  text-align: center;
}
.stat-icon { font-size: 22px; margin-bottom: 4px; }
.stat-value { font-family: var(--font-serif); font-size: 1.6rem; color: var(--slate); }
.stat-label { font-size: .7rem; color: var(--slate-soft); font-weight: 500; }

.quick-actions {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 10px; padding: 14px 16px;
}
.quick-btn {
  background: var(--white);
  border: 1.5px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 18px 14px;
  display: flex; align-items: center; gap: 12px;
  transition: border-color .18s, box-shadow .18s, transform .12s;
  cursor: pointer;
}
.quick-btn:hover { border-color: var(--sage); box-shadow: var(--shadow-md); transform: translateY(-1px); }
.quick-btn-icon {
  width: 44px; height: 44px; border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-size: 22px; flex-shrink: 0;
}
.qb-sage  { background: var(--sage-pale); }
.qb-amber { background: var(--amber-pale); }
.quick-btn-text { text-align: left; }
.quick-btn-title { font-weight: 600; font-size: .88rem; color: var(--slate); }
.quick-btn-sub   { font-size: .73rem; color: var(--slate-soft); margin-top: 2px; }

/* Timeline */
.timeline { padding: 0 16px; }
.timeline-item {
  display: flex; gap: 14px; margin-bottom: 14px;
}
.timeline-dot {
  width: 36px; height: 36px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; flex-shrink: 0;
  margin-top: 2px;
}
.td-meal    { background: var(--sage-pale); }
.td-symptom { background: var(--coral-pale); }
.timeline-content { flex: 1; }
.timeline-time { font-size: .72rem; color: var(--slate-soft); font-weight: 500; }
.timeline-main { font-size: .9rem; font-weight: 500; color: var(--slate); margin: 2px 0; }
.timeline-sub  { font-size: .78rem; color: var(--slate-soft); }
.timeline-line { width: 1px; background: var(--border); margin: 4px 17px; height: 10px; }

/* ============================================================
   VIEW : ADD MEAL
   ============================================================ */
.photo-zone {
  margin: 16px;
  border: 2px dashed var(--sage-light);
  border-radius: var(--radius-lg);
  background: var(--sage-faint);
  padding: 32px 20px;
  text-align: center;
  cursor: pointer;
  transition: background .18s, border-color .18s;
  position: relative;
  overflow: hidden;
}
.photo-zone:hover { background: var(--sage-pale); }
.photo-zone-icon { font-size: 40px; margin-bottom: 10px; }
.photo-zone-title { font-weight: 600; color: var(--sage); font-size: .95rem; }
.photo-zone-sub   { font-size: .78rem; color: var(--slate-soft); margin-top: 4px; }
#fileInput { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }

#photoPreview {
  display: none;
  margin: 16px;
  border-radius: var(--radius-lg);
  overflow: hidden;
  position: relative;
}
#photoPreview img { width: 100%; height: 200px; object-fit: cover; }
.photo-overlay {
  position: absolute; bottom: 0; left: 0; right: 0;
  background: linear-gradient(transparent, rgba(0,0,0,.7));
  padding: 24px 14px 14px;
  display: flex; align-items: center; justify-content: space-between;
}
.photo-overlay-text { color: white; font-size: .82rem; font-weight: 500; }

/* AI analysis result */
.ai-analysis {
  margin: 0 16px 16px;
  background: linear-gradient(135deg, #eef7f1, #f0f8f3);
  border: 1.5px solid #b8dfc4;
  border-radius: var(--radius-lg);
  padding: 16px;
}
.ai-header {
  display: flex; align-items: center; gap: 8px; margin-bottom: 12px;
}
.ai-badge {
  background: var(--sage); color: white;
  font-size: .7rem; font-weight: 600; letter-spacing: .04em;
  padding: 3px 9px; border-radius: 100px;
}
.ai-title { font-weight: 600; font-size: .9rem; color: var(--sage); }
.ingredient-chips { display: flex; flex-wrap: wrap; gap: 6px; }
.chip {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 5px 11px;
  border-radius: 100px;
  font-size: .78rem; font-weight: 500;
  border: 1.5px solid;
  cursor: pointer;
  transition: all .15s;
}
.chip-validated { background: var(--sage-pale); border-color: var(--sage-light); color: var(--sage); }
.chip-warning   { background: var(--amber-pale); border-color: var(--amber);       color: var(--amber); }
.chip-neutral   { background: var(--bg);         border-color: var(--border);      color: var(--slate-mid); }
.chip:hover { transform: scale(1.05); }

/* Fodmap indicator */
.fodmap-bar {
  margin-top: 12px;
  background: var(--white);
  border-radius: var(--radius-sm);
  padding: 10px 12px;
}
.fodmap-label { font-size: .72rem; font-weight: 600; color: var(--slate-soft); text-transform: uppercase; letter-spacing: .05em; margin-bottom: 6px; }
.fodmap-track {
  height: 8px; border-radius: 4px;
  background: linear-gradient(to right, #4a7c59 0%, #c8883a 50%, #d4605a 100%);
  position: relative; overflow: visible;
}
.fodmap-cursor {
  position: absolute; top: 50%; transform: translate(-50%,-50%);
  width: 16px; height: 16px;
  background: white; border: 2.5px solid var(--slate);
  border-radius: 50%;
  box-shadow: 0 2px 6px rgba(0,0,0,.2);
  transition: left .4s cubic-bezier(.34,1.56,.64,1);
}

/* Quantity row */
.qty-row { display: flex; gap: 10px; align-items: center; }
.qty-unit-select { flex: 1; }
.qty-val { width: 80px; }

/* ============================================================
   VIEW : SYMPTOMS
   ============================================================ */
.symptom-grid {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 10px; padding: 0 16px;
}
.symptom-card {
  background: var(--white);
  border: 1.5px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 16px 14px;
  transition: border-color .18s;
}
.symptom-card:hover { border-color: var(--sage); }
.symptom-card.active-card { border-color: var(--sage); background: var(--sage-faint); }
.symptom-card-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
.symptom-icon { font-size: 24px; }
.symptom-name { font-weight: 600; font-size: .85rem; color: var(--slate); }

/* Bristol scale */
.bristol-row {
  display: grid; grid-template-columns: repeat(7, 1fr);
  gap: 6px; margin: 0 16px;
}
.bristol-btn {
  background: var(--white);
  border: 1.5px solid var(--border);
  border-radius: var(--radius-md);
  padding: 10px 4px;
  text-align: center;
  cursor: pointer;
  transition: all .15s;
}
.bristol-btn:hover { border-color: var(--sage); }
.bristol-btn.selected { background: var(--sage); border-color: var(--sage); }
.bristol-num { font-family: var(--font-serif); font-size: 1.1rem; color: var(--slate); }
.bristol-btn.selected .bristol-num { color: white; }
.bristol-btn.selected .bristol-desc { color: rgba(255,255,255,.8); }
.bristol-desc { font-size: .6rem; color: var(--slate-soft); margin-top: 2px; }

.stool-legend {
  margin: 6px 16px 0;
  display: flex; gap: 6px; flex-wrap: wrap;
}
.stool-legend-item { font-size: .72rem; color: var(--slate-soft); }
.stool-legend-item span { font-weight: 600; color: var(--slate); }

/* ============================================================
   VIEW : HISTORIQUE / TIMELINE
   ============================================================ */
.history-filter {
  display: flex; gap: 8px; padding: 0 16px 16px; overflow-x: auto;
  scrollbar-width: none;
}
.filter-chip {
  flex-shrink: 0; padding: 7px 16px;
  border-radius: 100px;
  font-size: .8rem; font-weight: 500;
  border: 1.5px solid var(--border);
  color: var(--slate-mid);
  background: var(--white);
  cursor: pointer;
  transition: all .15s;
  white-space: nowrap;
}
.filter-chip.active { background: var(--sage); border-color: var(--sage); color: white; }

.day-group { margin: 0 16px 20px; }
.day-label {
  font-size: .75rem; font-weight: 600; letter-spacing: .05em; text-transform: uppercase;
  color: var(--slate-soft); margin-bottom: 10px;
}
.history-entry {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 14px;
  margin-bottom: 8px;
  display: flex; gap: 12px; align-items: flex-start;
}
.entry-icon-wrap {
  width: 38px; height: 38px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 20px; flex-shrink: 0;
}
.ei-meal    { background: var(--sage-pale); }
.ei-symptom { background: var(--coral-pale); }
.entry-body { flex: 1; min-width: 0; }
.entry-time { font-size: .72rem; color: var(--slate-soft); margin-bottom: 2px; }
.entry-title { font-weight: 600; font-size: .88rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.entry-detail { font-size: .78rem; color: var(--slate-soft); margin-top: 3px; }
.entry-pills { display: flex; gap: 5px; margin-top: 6px; flex-wrap: wrap; }

/* ============================================================
   VIEW : ANALYSE IA
   ============================================================ */
.ai-view-hero {
  margin: 0 16px 16px;
  background: linear-gradient(135deg, #1a3a27 0%, #2d5c40 100%);
  border-radius: var(--radius-lg);
  padding: 24px 20px;
  color: white;
  position: relative;
  overflow: hidden;
}
.ai-view-hero::before {
  content: '';
  position: absolute; top: -30px; right: -30px;
  width: 140px; height: 140px;
  border-radius: 50%;
  background: rgba(255,255,255,.05);
}
.ai-view-hero::after {
  content: '';
  position: absolute; bottom: -20px; left: 60px;
  width: 80px; height: 80px;
  border-radius: 50%;
  background: rgba(255,255,255,.04);
}
.ai-hero-label { font-size: .72rem; letter-spacing: .08em; text-transform: uppercase; color: rgba(255,255,255,.6); margin-bottom: 8px; }
.ai-hero-title { font-family: var(--font-serif); font-size: 1.5rem; line-height: 1.2; margin-bottom: 6px; }
.ai-hero-sub   { font-size: .82rem; color: rgba(255,255,255,.75); line-height: 1.4; }
.ai-hero-btn {
  display: inline-flex; align-items: center; gap: 7px;
  background: rgba(255,255,255,.15); border: 1px solid rgba(255,255,255,.25);
  color: white; padding: 10px 18px; border-radius: var(--radius-md);
  font-size: .85rem; font-weight: 500;
  margin-top: 16px;
  transition: background .18s;
  cursor: pointer;
}
.ai-hero-btn:hover { background: rgba(255,255,255,.22); }

/* Correlation cards */
.correlation-card {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 16px;
  margin: 0 16px 12px;
}
.corr-header {
  display: flex; align-items: center; gap: 10px; margin-bottom: 12px;
}
.corr-icon { font-size: 28px; }
.corr-title { font-weight: 600; font-size: .92rem; }
.corr-sub   { font-size: .78rem; color: var(--slate-soft); margin-top: 2px; }
.corr-confidence {
  margin-left: auto;
  font-family: var(--font-serif); font-size: 1.4rem; color: var(--sage);
}
.confidence-bar {
  height: 6px; border-radius: 3px; background: var(--border);
  margin-bottom: 12px; overflow: hidden;
}
.confidence-fill {
  height: 100%; border-radius: 3px;
  background: linear-gradient(to right, var(--sage), var(--sage-light));
  transition: width 1s ease;
}
.corr-detail { font-size: .8rem; color: var(--slate-mid); line-height: 1.5; }
.corr-detail strong { color: var(--slate); }

/* Chart placeholder */
.mini-chart {
  height: 80px;
  display: flex; align-items: flex-end; gap: 3px;
  padding: 0 2px;
  margin: 10px 0;
}
.chart-bar {
  flex: 1; border-radius: 4px 4px 0 0;
  transition: height .6s cubic-bezier(.34,1.56,.64,1);
}
.chart-bar-meal    { background: var(--sage-pale); border: 1px solid var(--sage-light); }
.chart-bar-symptom { background: var(--coral-pale); border: 1px solid var(--coral); }

/* Recommendation cards */
.reco-card {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 14px;
  margin: 0 16px 10px;
  display: flex; gap: 12px; align-items: flex-start;
}
.reco-num {
  width: 28px; height: 28px; border-radius: 8px;
  background: var(--sage-pale); color: var(--sage);
  font-weight: 700; font-size: .85rem;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.reco-body { font-size: .85rem; color: var(--slate-mid); line-height: 1.5; }
.reco-body strong { color: var(--slate); }

/* ============================================================
   VIEW : SYNTH√àSE
   ============================================================ */
.period-selector {
  display: flex; gap: 8px; padding: 0 16px 16px;
}
.period-btn {
  flex: 1; padding: 9px;
  border-radius: var(--radius-md);
  font-size: .82rem; font-weight: 500;
  border: 1.5px solid var(--border);
  color: var(--slate-mid);
  background: var(--white);
  text-align: center;
  cursor: pointer;
  transition: all .15s;
}
.period-btn.active { background: var(--sage); border-color: var(--sage); color: white; }

.summary-score-ring {
  display: flex; justify-content: center; padding: 8px 0 20px;
}
svg.ring { transform: rotate(-90deg); }
.ring-track { fill: none; stroke: var(--border); stroke-width: 10; }
.ring-fill  { fill: none; stroke: var(--sage); stroke-width: 10; stroke-linecap: round;
              stroke-dasharray: 251; stroke-dashoffset: 62; /* 75% */ transition: stroke-dashoffset 1.2s ease; }
.ring-label { text-anchor: middle; dominant-baseline: middle; font-family: var(--font-serif); }

.symptom-heatmap {
  margin: 0 16px;
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
}
.hm-day {
  aspect-ratio: 1;
  border-radius: 6px;
  display: flex; align-items: center; justify-content: center;
  font-size: .65rem; font-weight: 600; color: white;
}
.hm-0 { background: var(--border); color: var(--slate-soft); }
.hm-1 { background: #c8dfc9; color: var(--sage); }
.hm-2 { background: #f5d8a0; }
.hm-3 { background: var(--amber); }
.hm-4 { background: var(--coral); }

.hm-legend {
  display: flex; align-items: center; gap: 8px; padding: 8px 16px;
  font-size: .72rem; color: var(--slate-soft);
}
.hm-legend-dots { display: flex; gap: 4px; }
.hm-dot { width: 12px; height: 12px; border-radius: 3px; }

.export-row {
  display: flex; gap: 10px; padding: 0 16px;
  flex-wrap: wrap;
}

/* ============================================================
   MODAL / OVERLAY
   ============================================================ */
.modal-overlay {
  position: fixed; inset: 0; z-index: 200;
  background: rgba(0,0,0,.5);
  display: flex; align-items: flex-end; justify-content: center;
  opacity: 0; pointer-events: none;
  transition: opacity .25s;
}
.modal-overlay.open { opacity: 1; pointer-events: all; }
.modal-sheet {
  width: 100%; max-width: 600px;
  background: var(--white);
  border-radius: 24px 24px 0 0;
  padding: 12px 20px 32px;
  transform: translateY(100%);
  transition: transform .3s cubic-bezier(.32,.72,0,1);
  max-height: 90vh; overflow-y: auto;
}
.modal-overlay.open .modal-sheet { transform: translateY(0); }
.modal-handle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 18px; }
.modal-title { font-family: var(--font-serif); font-size: 1.3rem; margin-bottom: 16px; }

/* AI chat */
.ai-chat-area {
  background: var(--sage-faint);
  border-radius: var(--radius-lg);
  padding: 16px;
  margin: 12px 0;
  min-height: 100px;
}
.chat-bubble {
  background: var(--white);
  border-radius: 0 14px 14px 14px;
  padding: 12px 14px;
  font-size: .87rem; line-height: 1.55;
  color: var(--slate);
  box-shadow: var(--shadow-sm);
  margin-bottom: 12px;
}
.chat-bubble-user {
  background: var(--sage);
  border-radius: 14px 0 14px 14px;
  color: white;
  margin-left: 20%;
}
.chat-thinking {
  display: flex; gap: 4px; align-items: center; padding: 8px 0;
}
.chat-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--sage-light);
  animation: bounce 1.2s infinite;
}
.chat-dot:nth-child(2) { animation-delay: .15s; }
.chat-dot:nth-child(3) { animation-delay: .3s; }
@keyframes bounce { 0%,80%,100% {transform:scale(1);opacity:.5;} 40% {transform:scale(1.3);opacity:1;} }

/* Loading spinner */
.spinner {
  width: 20px; height: 20px; border-radius: 50%;
  border: 2.5px solid var(--sage-pale);
  border-top-color: var(--sage);
  animation: spin .7s linear infinite; display: inline-block;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Toast */
.toast {
  position: fixed; bottom: calc(var(--bottom-h) + 16px); left: 50%; transform: translateX(-50%) translateY(20px);
  background: var(--slate);
  color: white; padding: 10px 20px; border-radius: 100px;
  font-size: .85rem; font-weight: 500;
  z-index: 300; opacity: 0;
  transition: all .3s;
  white-space: nowrap;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ============================================================
   UTILITY
   ============================================================ */
.mt-8  { margin-top: 8px; }
.mt-12 { margin-top: 12px; }
.mt-16 { margin-top: 16px; }
.mb-0  { margin-bottom: 0; }
.text-center { text-align: center; }
.text-sm { font-size: .82rem; color: var(--slate-soft); }
.fw-600 { font-weight: 600; }
.flex-row { display: flex; align-items: center; }
.gap-8 { gap: 8px; }
.p-16 { padding: 0 16px; }
.full-btn { width: 100%; justify-content: center; }

/* Responsive cap */
@media (min-width: 480px) {
  .app-main, .bottom-nav, .app-header { max-width: 480px; margin: 0 auto; }
  .app-header { left: 50%; transform: translateX(-50%); }
}
</style>
</head>

<body>

<!-- ============================================================
     APP HEADER
     ============================================================ -->
<header class="app-header">
  <div class="app-logo">
    <div class="app-logo-icon">üåø</div>
    <div class="app-logo-text">Gut<span>Track</span></div>
  </div>
  <div class="header-actions">
    <button class="btn-icon" title="Notifications">üîî</button>
    <button class="btn-icon" onclick="navigate('synthese')" title="Synth√®se">üìä</button>
  </div>
</header>

<!-- ============================================================
     MAIN ‚Äî Router Outlet
     ============================================================ -->
<main class="app-main">

  <!-- ‚ïê‚ïê VIEW: DASHBOARD ‚ïê‚ïê -->
  <div id="view-dashboard" class="view active">
    <div class="dashboard-greeting">
      <div class="greeting-date" id="greetingDate">Mardi 17 f√©vrier 2026</div>
      <h1 class="greeting-title">Bonjour,<br><em>comment vous sentez-vous ?</em></h1>
    </div>

    <!-- Stats du jour -->
    <div class="stats-row mt-12">
      <div class="stat-card">
        <div class="stat-icon">üçΩÔ∏è</div>
        <div class="stat-value" id="statMeals">0</div>
        <div class="stat-label">Repas</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üìù</div>
        <div class="stat-value" id="statSymptoms">0</div>
        <div class="stat-label">Sympt√¥mes</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üìÖ</div>
        <div class="stat-value">14</div>
        <div class="stat-label">Jours suivis</div>
      </div>
    </div>

    <!-- Quick actions -->
    <div class="quick-actions">
      <button class="quick-btn" onclick="navigate('repas')">
        <div class="quick-btn-icon qb-sage">üç¥</div>
        <div class="quick-btn-text">
          <div class="quick-btn-title">Ajouter repas</div>
          <div class="quick-btn-sub">Photo ou texte</div>
        </div>
      </button>
      <button class="quick-btn" onclick="navigate('symptomes')">
        <div class="quick-btn-icon qb-amber">üíä</div>
        <div class="quick-btn-text">
          <div class="quick-btn-title">Sympt√¥mes</div>
          <div class="quick-btn-sub">Saisir maint.</div>
        </div>
      </button>
    </div>

    <!-- Alerte AI si donn√©es disponibles -->
    <div class="card" style="margin-top:4px; border-color: #b8dfc4; background: linear-gradient(135deg,#f0f8f3,#eef7f1);">
      <div class="card-body">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
          <span style="font-size:20px">ü§ñ</span>
          <span style="font-weight:600; font-size:.9rem; color:var(--sage)">Analyse IA disponible</span>
          <span class="pill pill-sage" style="margin-left:auto; font-size:.68rem">Nouveau</span>
        </div>
        <p style="font-size:.82rem; color:var(--slate-mid); line-height:1.5; margin-bottom:12px;">
          Une corr√©lation a √©t√© d√©tect√©e entre votre consommation de <strong>lactose</strong> et les ballonnements signal√©s 2‚Äì4h apr√®s.
        </p>
        <button class="btn-secondary" onclick="navigate('analyse')">Voir l'analyse ‚Üí</button>
      </div>
    </div>

    <!-- Timeline du jour -->
    <div class="section-header mt-8">
      <div>
        <div class="section-title">Aujourd'hui</div>
        <div class="section-sub">Journal chronologique</div>
      </div>
    </div>
    <div class="timeline" id="dashTimeline">
      <div style="text-align:center; padding:24px 0; color:var(--slate-soft); font-size:.85rem;">
        Aucune entr√©e aujourd'hui.<br>
        <button class="btn-secondary mt-12" onclick="navigate('repas')">Ajouter votre premier repas</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê VIEW: REPAS ‚ïê‚ïê -->
  <div id="view-repas" class="view">
    <div class="section-header">
      <div>
        <div class="section-title">Nouveau repas</div>
        <div class="section-sub" id="mealDateTime">17/02/2026 ‚Äî 12:30</div>
      </div>
      <button class="btn-icon" onclick="updateMealTime()">üïê</button>
    </div>

    <!-- Photo upload -->
    <div class="photo-zone" id="photoZone">
      <input type="file" id="fileInput" accept="image/*" onchange="handlePhoto(event)">
      <div class="photo-zone-icon">üì∏</div>
      <div class="photo-zone-title">Photographier votre repas</div>
      <div class="photo-zone-sub">L'IA identifiera les aliments automatiquement</div>
    </div>

    <!-- Photo preview -->
    <div id="photoPreview">
      <img id="previewImg" src="" alt="Aper√ßu repas">
      <div class="photo-overlay">
        <span class="photo-overlay-text">üì∏ Photo import√©e</span>
        <button onclick="resetPhoto()" style="color:white; font-size:.8rem; background:rgba(255,255,255,.2); padding:5px 10px; border-radius:8px;">Changer</button>
      </div>
    </div>

    <!-- AI Analysis -->
    <div class="ai-analysis" id="aiAnalysis" style="display:none">
      <div class="ai-header">
        <span class="ai-badge">IA</span>
        <span class="ai-title">Ingr√©dients identifi√©s</span>
        <button onclick="reanalyzePhoto()" title="Relancer l'analyse" style="margin-left:auto; font-size:.72rem; color:var(--sage); font-weight:600; background:rgba(74,124,89,.12); border:none; padding:4px 10px; border-radius:100px; cursor:pointer;">üîÑ R√©analyser</button>
      </div>

      <!-- Legend -->
      <div style="display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap;">
        <span style="font-size:.7rem; color:var(--slate-soft); display:flex; align-items:center; gap:4px;"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--sage)"></span>Certain (visible)</span>
        <span style="font-size:.7rem; color:var(--slate-soft); display:flex; align-items:center; gap:4px;"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--amber)"></span>Probable (suppos√©)</span>
        <span style="font-size:.7rem; color:var(--coral); display:flex; align-items:center; gap:4px;"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--coral)"></span>FODMAP √©lev√©</span>
      </div>

      <div class="ingredient-chips" id="ingredientChips"></div>

      <!-- Missed ingredients prompt -->
      <div style="margin-top:10px; padding:8px 10px; background:rgba(200,136,58,.08); border-radius:var(--radius-sm); border-left:3px solid var(--amber); display:flex; align-items:center; gap:8px;">
        <span style="font-size:.75rem; color:var(--amber); font-weight:600;">Un ingr√©dient manque ?</span>
        <span style="font-size:.72rem; color:var(--slate-soft);">Ajoutez-le ci-dessous ‚Üì</span>
      </div>

      <div class="fodmap-bar mt-12">
        <div class="fodmap-label">Charge FODMAP estim√©e</div>
        <div class="fodmap-track">
          <div class="fodmap-cursor" id="fodmapCursor" style="left:30%"></div>
        </div>
        <div style="display:flex; justify-content:space-between; margin-top:4px;">
          <span style="font-size:.68rem; color:var(--sage)">Faible</span>
          <span style="font-size:.68rem; color:var(--amber)">Mod√©r√©e</span>
          <span style="font-size:.68rem; color:var(--coral)">√âlev√©e</span>
        </div>
      </div>

      <!-- AI reasoning note -->
      <div id="aiReasoning" style="margin-top:10px; font-size:.72rem; color:var(--slate-soft); line-height:1.5; font-style:italic;"></div>
    </div>

    <!-- Thinking indicator -->
    <div id="aiThinking" style="display:none; margin: 12px 16px;">
      <div style="display:flex; align-items:center; gap:10px; color:var(--sage); font-size:.85rem; font-weight:500;">
        <div class="spinner"></div>
        Analyse de la photo en cours‚Ä¶
      </div>
    </div>

    <!-- Form -->
    <div class="card">
      <div class="card-body">
        <div class="form-group">
          <label class="form-label">Description du repas</label>
          <textarea class="form-control form-textarea" id="mealDesc" placeholder="Ex : Bol de p√¢tes compl√®tes, sauce tomate maison, parmesan, salade verte‚Ä¶" rows="3"></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Type de repas</label>
          <select class="form-control" id="mealType">
            <option>Petit-d√©jeuner</option>
            <option selected>D√©jeuner</option>
            <option>D√Æner</option>
            <option>Collation</option>
            <option>Boisson</option>
          </select>
        </div>

        <div class="form-group mb-0">
          <label class="form-label">Quantit√© approximative</label>
          <div class="qty-row">
            <input class="form-control qty-val" type="number" id="mealQty" placeholder="300" min="1">
            <select class="form-control qty-unit-select" id="mealUnit">
              <option>g</option>
              <option>ml</option>
              <option>portion(s)</option>
              <option>tasse(s)</option>
              <option>cuill√®re(s)</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Manual ingredient entry -->
    <div class="card">
      <div class="card-body">
        <label class="form-label">Ajouter un ingr√©dient manuellement</label>
        <div style="display:flex; gap:8px;">
          <input class="form-control" type="text" id="manualIngredient" placeholder="Ex : brocoli, gluten, lactose‚Ä¶" style="flex:1">
          <button class="btn-secondary" onclick="addManualIngredient()">+</button>
        </div>
        <div class="ingredient-chips mt-12" id="manualChips" style="min-height:20px"></div>
      </div>
    </div>

    <div class="p-16">
      <button class="btn-primary full-btn" onclick="saveMeal()">
        ‚úÖ Enregistrer ce repas
      </button>
    </div>
  </div>

  <!-- ‚ïê‚ïê VIEW: SYMPT√îMES ‚ïê‚ïê -->
  <div id="view-symptomes" class="view">
    <div class="section-header">
      <div>
        <div class="section-title">Sympt√¥mes</div>
        <div class="section-sub" id="symptomDateTime">17/02/2026 ‚Äî 12:30</div>
      </div>
      <button class="btn-icon" onclick="updateSymptomTime()">üïê</button>
    </div>

    <!-- Symptom cards grid -->
    <div class="symptom-grid">
      <!-- Douleur abdominale -->
      <div class="symptom-card" id="sc-douleur">
        <div class="symptom-card-header">
          <span class="symptom-icon">üò£</span>
          <span class="symptom-name">Douleur abdo.</span>
        </div>
        <div class="score-row" id="sr-douleur" data-key="douleur"></div>
      </div>

      <!-- Ballonnements -->
      <div class="symptom-card" id="sc-ballon">
        <div class="symptom-card-header">
          <span class="symptom-icon">ü´ß</span>
          <span class="symptom-name">Ballonnements</span>
        </div>
        <div class="score-row" id="sr-ballon" data-key="ballon"></div>
      </div>

      <!-- Gaz -->
      <div class="symptom-card" id="sc-gaz">
        <div class="symptom-card-header">
          <span class="symptom-icon">üí®</span>
          <span class="symptom-name">Gaz</span>
        </div>
        <div class="score-row" id="sr-gaz" data-key="gaz"></div>
      </div>

      <!-- √âructations -->
      <div class="symptom-card" id="sc-eructation">
        <div class="symptom-card-header">
          <span class="symptom-icon">ü´Å</span>
          <span class="symptom-name">√âructations</span>
        </div>
        <div class="score-row" id="sr-eructation" data-key="eructation"></div>
      </div>

      <!-- Naus√©e -->
      <div class="symptom-card" id="sc-nausee">
        <div class="symptom-card-header">
          <span class="symptom-icon">ü§¢</span>
          <span class="symptom-name">Naus√©e</span>
        </div>
        <div class="score-row" id="sr-nausee" data-key="nausee"></div>
      </div>

      <!-- Maux de t√™te -->
      <div class="symptom-card" id="sc-cephale">
        <div class="symptom-card-header">
          <span class="symptom-icon">ü§ï</span>
          <span class="symptom-name">Maux de t√™te</span>
        </div>
        <div class="score-row" id="sr-cephale" data-key="cephale"></div>
      </div>
    </div>

    <!-- Scale legend -->
    <div style="padding: 6px 16px; font-size:.72rem; color:var(--slate-soft); display:flex; gap:12px; flex-wrap:wrap;">
      <span>0 = absent</span>
      <span>üü° 3‚Äì5 = mod√©r√©</span>
      <span>üî¥ 7‚Äì10 = s√©v√®re</span>
    </div>

    <!-- Bristol -->
    <div class="section-header mt-8" style="padding-bottom:0">
      <div class="section-title" style="font-size:1.1rem">Selles ‚Äî √âchelle de Bristol</div>
    </div>
    <div style="padding: 8px 16px; font-size:.78rem; color:var(--slate-soft); line-height:1.5; margin-bottom:8px;">
      S√©lectionnez le type de selle le plus proche de votre observation :
    </div>
    <div class="bristol-row" id="bristolRow">
      <!-- generated by JS -->
    </div>
    <div class="stool-legend">
      <span class="stool-legend-item"><span>1-2</span> = dur/grumeleux (constipation)</span>
      <span class="stool-legend-item"><span>3-4</span> = normal</span>
      <span class="stool-legend-item"><span>5-7</span> = mou/liquide (diarrh√©e)</span>
    </div>

    <!-- Notes libres -->
    <div class="card mt-16">
      <div class="card-body">
        <div class="form-group mb-0">
          <label class="form-label">Notes compl√©mentaires</label>
          <textarea class="form-control form-textarea" id="symptomNotes" placeholder="Ex : sympt√¥mes apparus 2h apr√®s le d√©jeuner, stress au travail, m√©dicaments pris‚Ä¶"></textarea>
        </div>
      </div>
    </div>

    <!-- Contexte -->
    <div class="card">
      <div class="card-body">
        <label class="form-label">Contexte associ√©</label>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn-outline" id="ctx-stress" onclick="toggleContext('stress')" style="flex:1; min-width:100px;">üò∞ Stress</button>
          <button class="btn-outline" id="ctx-sommeil" onclick="toggleContext('sommeil')" style="flex:1; min-width:100px;">üò¥ Manque sommeil</button>
          <button class="btn-outline" id="ctx-sport"   onclick="toggleContext('sport')"   style="flex:1; min-width:100px;">üèÉ Sport</button>
          <button class="btn-outline" id="ctx-regles"  onclick="toggleContext('regles')"  style="flex:1; min-width:100px;">ü©∏ R√®gles</button>
        </div>
      </div>
    </div>

    <div class="p-16">
      <button class="btn-primary full-btn" onclick="saveSymptoms()">
        ‚úÖ Enregistrer les sympt√¥mes
      </button>
    </div>
  </div>

  <!-- ‚ïê‚ïê VIEW: HISTORIQUE ‚ïê‚ïê -->
  <div id="view-historique" class="view">
    <div class="section-header">
      <div>
        <div class="section-title">Historique</div>
        <div class="section-sub">Journal complet</div>
      </div>
    </div>

    <div class="history-filter">
      <button class="filter-chip active" onclick="filterHistory('all', this)">Tout</button>
      <button class="filter-chip" onclick="filterHistory('meal', this)">üçΩÔ∏è Repas</button>
      <button class="filter-chip" onclick="filterHistory('symptom', this)">üíä Sympt√¥mes</button>
      <button class="filter-chip" onclick="filterHistory('alert', this)">‚ö†Ô∏è Alertes</button>
    </div>

    <div id="historyContent">
      <!-- Generated by JS -->
    </div>
  </div>

  <!-- ‚ïê‚ïê VIEW: ANALYSE IA ‚ïê‚ïê -->
  <div id="view-analyse" class="view">
    <div class="section-header">
      <div>
        <div class="section-title">Analyse IA</div>
        <div class="section-sub">Corr√©lations & recommandations</div>
      </div>
    </div>

    <div class="ai-view-hero">
      <div class="ai-hero-label">ü§ñ Intelligence artificielle</div>
      <div class="ai-hero-title">Analyse de vos<br>14 derniers jours</div>
      <div class="ai-hero-sub">Bas√©e sur 38 repas et 22 entr√©es de sympt√¥mes. Des patterns sont d√©tect√©s.</div>
      <button class="ai-hero-btn" onclick="openAiChat()">üí¨ Poser une question √† l'IA ‚Üí</button>
    </div>

    <!-- Corr√©lations -->
    <div class="section-header">
      <div class="section-title" style="font-size:1.1rem">Corr√©lations d√©tect√©es</div>
    </div>

    <div class="correlation-card">
      <div class="corr-header">
        <span class="corr-icon">ü•õ</span>
        <div>
          <div class="corr-title">Lactose ‚Üí Ballonnements</div>
          <div class="corr-sub">R√©action 2‚Äì4h apr√®s ingestion</div>
        </div>
        <div class="corr-confidence">82%</div>
      </div>
      <div class="confidence-bar"><div class="confidence-fill" style="width:82%"></div></div>
      <div class="mini-chart">
        <div class="chart-bar chart-bar-meal"    style="height:40%"></div>
        <div class="chart-bar chart-bar-symptom" style="height:15%"></div>
        <div class="chart-bar chart-bar-meal"    style="height:70%"></div>
        <div class="chart-bar chart-bar-symptom" style="height:65%"></div>
        <div class="chart-bar chart-bar-meal"    style="height:30%"></div>
        <div class="chart-bar chart-bar-symptom" style="height:10%"></div>
        <div class="chart-bar chart-bar-meal"    style="height:80%"></div>
        <div class="chart-bar chart-bar-symptom" style="height:75%"></div>
        <div class="chart-bar chart-bar-meal"    style="height:20%"></div>
        <div class="chart-bar chart-bar-symptom" style="height:5%"></div>
      </div>
      <div class="corr-detail">
        Sur les 14 jours analys√©s, <strong>8 des 10 √©pisodes de ballonnements s√©v√®res</strong> (score ‚â•6) ont eu lieu dans les 4h suivant une consommation de produits laitiers. Corr√©lation temporelle forte.
      </div>
    </div>

    <div class="correlation-card">
      <div class="corr-header">
        <span class="corr-icon">üåæ</span>
        <div>
          <div class="corr-title">Gluten ‚Äî donn√©es insuffisantes</div>
          <div class="corr-sub">Suivre 2 semaines suppl√©mentaires</div>
        </div>
        <div class="corr-confidence" style="color:var(--amber)">41%</div>
      </div>
      <div class="confidence-bar"><div class="confidence-fill" style="width:41%; background:linear-gradient(to right, var(--amber), #e6a85a)"></div></div>
      <div class="corr-detail">Corr√©lation possible mais non confirm√©e. Il faudrait <strong>au moins 3 semaines de donn√©es suppl√©mentaires</strong> pour conclure. Continuez √† enregistrer vos repas.</div>
    </div>

    <div class="correlation-card">
      <div class="corr-header">
        <span class="corr-icon">üò∞</span>
        <div>
          <div class="corr-title">Stress ‚Üí Gaz & douleurs</div>
          <div class="corr-sub">Facteur aggravant identifi√©</div>
        </div>
        <div class="corr-confidence">67%</div>
      </div>
      <div class="confidence-bar"><div class="confidence-fill" style="width:67%"></div></div>
      <div class="corr-detail">Les journ√©es marqu√©es <strong>¬´ stress ¬ª</strong> pr√©sentent en moyenne un score de douleur 2.4 points sup√©rieur aux autres jours, ind√©pendamment de l'alimentation. Typique du SII (axe intestin-cerveau).</div>
    </div>

    <!-- Recommandations -->
    <div class="section-header mt-8">
      <div class="section-title" style="font-size:1.1rem">Recommandations personnalis√©es</div>
    </div>

    <div class="reco-card">
      <div class="reco-num">1</div>
      <div class="reco-body"><strong>Essayez 3 semaines sans lactose</strong> pour confirmer la corr√©lation. Substituts : lait d'avoine ou amande, yaourts lactose-free.</div>
    </div>
    <div class="reco-card">
      <div class="reco-num">2</div>
      <div class="reco-body"><strong>R√©gime Low-FODMAP</strong> : votre profil correspond. Consultez la liste des aliments autoris√©s. Je peux vous g√©n√©rer un menu adapt√©.</div>
    </div>
    <div class="reco-card">
      <div class="reco-num">3</div>
      <div class="reco-body"><strong>SIBO √† exclure</strong> : vos sympt√¥mes (ballonnements, √©ructations, gaz) peuvent √©voquer un SIBO. Un test respiratoire (H2/CH4) serait √† envisager avec votre m√©decin.</div>
    </div>
    <div class="reco-card">
      <div class="reco-num">4</div>
      <div class="reco-body"><strong>Gestion du stress</strong> : l'axe intestin-cerveau joue un r√¥le cl√© dans le SII. Coh√©rence cardiaque 3√ó/jour ou m√©ditation peuvent r√©duire les sympt√¥mes de 30 √† 40%.</div>
    </div>

    <div style="height:8px"></div>
  </div>

  <!-- ‚ïê‚ïê VIEW: SYNTH√àSE ‚ïê‚ïê -->
  <div id="view-synthese" class="view">
    <div class="section-header">
      <div>
        <div class="section-title">Synth√®se</div>
        <div class="section-sub">Bilan & export</div>
      </div>
    </div>

    <!-- Period selector -->
    <div class="period-selector">
      <button class="period-btn active" onclick="selectPeriod(7, this)">7 jours</button>
      <button class="period-btn" onclick="selectPeriod(14, this)">14 jours</button>
      <button class="period-btn" onclick="selectPeriod(30, this)">1 mois</button>
    </div>

    <!-- Score ring -->
    <div class="summary-score-ring">
      <svg class="ring" width="160" height="160" viewBox="0 0 90 90">
        <circle class="ring-track" cx="45" cy="45" r="40"/>
        <circle class="ring-fill" id="wellbeingRing" cx="45" cy="45" r="40"/>
        <text class="ring-label" x="45" y="45" transform="rotate(90 45 45)" font-size="16" fill="#2d3748" font-weight="600">73</text>
        <text class="ring-label" x="45" y="57" transform="rotate(90 45 45)" font-size="7" fill="#718096">/ 100</text>
        <text class="ring-label" x="45" y="33" transform="rotate(90 45 45)" font-size="6" fill="#4a7c59" font-weight="600">BIEN-√äTRE</text>
      </svg>
    </div>

    <!-- Key numbers -->
    <div class="stats-row" style="margin-top:0">
      <div class="stat-card">
        <div class="stat-icon">üçΩÔ∏è</div>
        <div class="stat-value">38</div>
        <div class="stat-label">Repas</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üò£</div>
        <div class="stat-value">22</div>
        <div class="stat-label">Episodes</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚ö†Ô∏è</div>
        <div class="stat-value">3</div>
        <div class="stat-label">Alertes</div>
      </div>
    </div>

    <!-- Heatmap -->
    <div class="section-header mt-16">
      <div class="section-title" style="font-size:1.1rem">Intensit√© des sympt√¥mes</div>
    </div>
    <div class="symptom-heatmap" id="heatmap"></div>
    <div class="hm-legend">
      <span>Aucun</span>
      <div class="hm-legend-dots">
        <div class="hm-dot hm-0" style="background:var(--border)"></div>
        <div class="hm-dot" style="background:#c8dfc9"></div>
        <div class="hm-dot" style="background:#f5d8a0"></div>
        <div class="hm-dot" style="background:var(--amber)"></div>
        <div class="hm-dot" style="background:var(--coral)"></div>
      </div>
      <span>S√©v√®re</span>
    </div>

    <!-- Top triggers -->
    <div class="card mt-16">
      <div class="card-body">
        <div class="fw-600" style="font-size:.9rem; margin-bottom:12px;">üö® Aliments d√©clencheurs</div>
        <div style="display:flex; flex-direction:column; gap:8px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <span style="font-size:.85rem;">ü•õ Produits laitiers (lactose)</span>
            <div style="display:flex; align-items:center; gap:8px;">
              <div style="width:80px; height:6px; border-radius:3px; background:var(--border); overflow:hidden;"><div style="width:82%; height:100%; background:var(--coral); border-radius:3px;"></div></div>
              <span style="font-size:.75rem; color:var(--coral); font-weight:600;">82%</span>
            </div>
          </div>
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <span style="font-size:.85rem;">üßÖ Oignons / ail (fructanes)</span>
            <div style="display:flex; align-items:center; gap:8px;">
              <div style="width:80px; height:6px; border-radius:3px; background:var(--border); overflow:hidden;"><div style="width:58%; height:100%; background:var(--amber); border-radius:3px;"></div></div>
              <span style="font-size:.75rem; color:var(--amber); font-weight:600;">58%</span>
            </div>
          </div>
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <span style="font-size:.85rem;">‚òï Caf√© (√† jeun)</span>
            <div style="display:flex; align-items:center; gap:8px;">
              <div style="width:80px; height:6px; border-radius:3px; background:var(--border); overflow:hidden;"><div style="width:44%; height:100%; background:var(--sage-light); border-radius:3px;"></div></div>
              <span style="font-size:.75rem; color:var(--sage); font-weight:600;">44%</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Export -->
    <div class="section-header mt-8">
      <div class="section-title" style="font-size:1.1rem">Exporter</div>
    </div>
    <div class="export-row">
      <button class="btn-secondary" onclick="exportPDF()" style="flex:1; justify-content:center;">üìÑ Rapport PDF</button>
      <button class="btn-outline" onclick="exportCSV()" style="flex:1; justify-content:center;">üìä CSV</button>
    </div>
    <div style="margin: 10px 16px; font-size:.75rem; color:var(--slate-soft); line-height:1.5;">
      Le rapport PDF inclut : timeline compl√®te, graphiques, corr√©lations IA, recommandations ‚Äî id√©al √† partager avec votre gastro-ent√©rologue.
    </div>

    <div style="height:16px"></div>
  </div>

</main>

<!-- ============================================================
     BOTTOM NAV
     ============================================================ -->
<nav class="bottom-nav">
  <div class="nav-item active" onclick="navigate('dashboard')" id="nav-dashboard">
    <span class="nav-icon">üè†</span>
    <span class="nav-label">Accueil</span>
  </div>
  <div class="nav-item" onclick="navigate('repas')" id="nav-repas">
    <span class="nav-icon">üç¥</span>
    <span class="nav-label">Repas</span>
  </div>
  <div class="nav-item" onclick="navigate('symptomes')" id="nav-symptomes">
    <span class="nav-icon">üíä</span>
    <span class="nav-label">Sympt√¥mes</span>
  </div>
  <div class="nav-item" onclick="navigate('historique')" id="nav-historique">
    <span class="nav-icon">üìã</span>
    <span class="nav-label">Historique</span>
  </div>
  <div class="nav-item" onclick="navigate('analyse')" id="nav-analyse">
    <span class="nav-icon">ü§ñ</span>
    <span class="nav-label">IA</span>
  </div>
</nav>

<!-- ============================================================
     MODAL ‚Äî AI Chat
     ============================================================ -->
<div class="modal-overlay" id="aiChatModal" onclick="closeModal(event)">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">ü§ñ Parler √† l'IA GutTrack</div>
    <div style="font-size:.8rem; color:var(--slate-soft); margin-bottom:12px; line-height:1.5;">
      L'IA a acc√®s √† tout votre journal. Posez-lui n'importe quelle question sur vos sympt√¥mes, vos aliments ou votre sant√© digestive.
    </div>

    <div class="ai-chat-area" id="chatArea">
      <div class="chat-bubble">
        Bonjour ! J'ai analys√© vos 14 derniers jours de donn√©es. Je vois que vous avez eu plusieurs √©pisodes de ballonnements importants. Que souhaitez-vous savoir ?
      </div>
    </div>

    <div style="display:flex; gap:8px; margin-top:8px;">
      <input class="form-control" type="text" id="chatInput" placeholder="Ex : Quels aliments √©viter ce soir ?" style="flex:1">
      <button class="btn-primary" onclick="sendAiMessage()" style="padding:11px 16px; flex-shrink:0;">‚û§</button>
    </div>

    <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:10px;">
      <button class="filter-chip" style="font-size:.72rem; padding:5px 11px;" onclick="prefillChat('R√©sume mes sympt√¥mes de cette semaine')">R√©sum√© semaine</button>
      <button class="filter-chip" style="font-size:.72rem; padding:5px 11px;" onclick="prefillChat('Quels aliments sont sans risque pour moi ?')">Aliments s√ªrs</button>
      <button class="filter-chip" style="font-size:.72rem; padding:5px 11px;" onclick="prefillChat('Est-ce que j\'ai un profil SIBO ou SII ?')">SII ou SIBO ?</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- ============================================================
     ANGULAR-STYLE SERVICES & CONTROLLERS
     ============================================================ -->
<script>
/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   AppState ‚Äî Service singleton (Angular DataService)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const AppState = {
  meals: JSON.parse(localStorage.getItem('gt_meals') || '[]'),
  symptoms: JSON.parse(localStorage.getItem('gt_symptoms') || '[]'),
  currentSymptomScores: {},
  currentBristol: null,
  currentContexts: [],
  manualIngredients: [],
  analysisIngredients: [],

  saveMeals()    { localStorage.setItem('gt_meals',    JSON.stringify(this.meals)); },
  saveSymptoms() { localStorage.setItem('gt_symptoms', JSON.stringify(this.symptoms)); },

  addMeal(meal) {
    this.meals.unshift({ ...meal, id: Date.now(), createdAt: new Date().toISOString() });
    this.saveMeals();
  },
  addSymptom(sym) {
    this.symptoms.unshift({ ...sym, id: Date.now(), createdAt: new Date().toISOString() });
    this.saveSymptoms();
  },
  getTodayEntries() {
    const today = new Date().toDateString();
    const meals = this.meals.filter(m => new Date(m.createdAt).toDateString() === today);
    const syms  = this.symptoms.filter(s => new Date(s.createdAt).toDateString() === today);
    return [...meals.map(m => ({...m, kind:'meal'})), ...syms.map(s => ({...s, kind:'symptom'}))]
      .sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
  }
};

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   Router ‚Äî navigate(routeName)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function navigate(route) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

  const view = document.getElementById('view-' + route);
  const nav  = document.getElementById('nav-' + route);
  if (view) view.classList.add('active');
  if (nav)  nav.classList.add('active');

  // Lifecycle hooks
  if (route === 'dashboard')  DashboardComponent.onInit();
  if (route === 'repas')      MealComponent.onInit();
  if (route === 'symptomes')  SymptomComponent.onInit();
  if (route === 'historique') HistoryComponent.onInit();
  if (route === 'synthese')   SyntheseComponent.onInit();

  window.scrollTo(0, 0);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   Utilities
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function formatDate(d) {
  return d.toLocaleDateString('fr-FR', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
}
function formatDateTime(d) {
  return d.toLocaleDateString('fr-FR') + ' ‚Äî ' + d.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' });
}
function formatTime(d) {
  return d.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' });
}

function showToast(msg, duration = 2500) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

function scoreColor(v) {
  if (v <= 2) return '';
  if (v <= 5) return 'sel-amber';
  return 'sel-coral';
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   DashboardComponent
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const DashboardComponent = {
  onInit() {
    document.getElementById('greetingDate').textContent = formatDate(new Date());
    const today = new Date().toDateString();
    const todayMeals    = AppState.meals.filter(m => new Date(m.createdAt).toDateString() === today);
    const todaySymptoms = AppState.symptoms.filter(s => new Date(s.createdAt).toDateString() === today);
    document.getElementById('statMeals').textContent    = todayMeals.length;
    document.getElementById('statSymptoms').textContent = todaySymptoms.length;
    this.renderTimeline();
  },
  renderTimeline() {
    const entries = AppState.getTodayEntries();
    const el = document.getElementById('dashTimeline');
    if (entries.length === 0) {
      el.innerHTML = `<div style="text-align:center;padding:24px 0;color:var(--slate-soft);font-size:.85rem;">
        Aucune entr√©e aujourd'hui.<br>
        <button class="btn-secondary mt-12" onclick="navigate('repas')">Ajouter votre premier repas</button>
      </div>`;
      return;
    }
    el.innerHTML = entries.map(e => {
      if (e.kind === 'meal') {
        const items = (e.ingredients || []).slice(0,3).join(', ');
        return `<div class="timeline-item">
          <div class="timeline-dot td-meal">üç¥</div>
          <div class="timeline-content">
            <div class="timeline-time">${formatTime(new Date(e.createdAt))}</div>
            <div class="timeline-main">${e.mealType} ‚Äî ${e.description?.substring(0,40) || 'Repas enregistr√©'}‚Ä¶</div>
            <div class="timeline-sub">${items || ''} ${e.quantity ? '¬∑ ' + e.quantity + ' ' + e.unit : ''}</div>
          </div>
        </div>`;
      } else {
        const syms = Object.entries(e.scores || {}).filter(([,v]) => v > 0).map(([k,v]) => `${k} (${v}/10)`).join(', ');
        return `<div class="timeline-item">
          <div class="timeline-dot td-symptom">üíä</div>
          <div class="timeline-content">
            <div class="timeline-time">${formatTime(new Date(e.createdAt))}</div>
            <div class="timeline-main">Sympt√¥mes signal√©s</div>
            <div class="timeline-sub">${syms || 'Aucun sympt√¥me majeur'}</div>
          </div>
        </div>`;
      }
    }).join('<div class="timeline-line"></div>');
  }
};

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   MealComponent
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const MealComponent = {
  onInit() {
    document.getElementById('mealDateTime').textContent = formatDateTime(new Date());
    AppState.manualIngredients = [];
    AppState.analysisIngredients = [];
    document.getElementById('manualChips').innerHTML = '';
    document.getElementById('ingredientChips').innerHTML = '';
    document.getElementById('aiAnalysis').style.display = 'none';
    document.getElementById('aiThinking').style.display = 'none';
    document.getElementById('photoPreview').style.display = 'none';
    document.getElementById('photoZone').style.display = 'block';
    document.getElementById('mealDesc').value = '';
    document.getElementById('mealQty').value = '';
  }
};

function updateMealTime() {
  document.getElementById('mealDateTime').textContent = formatDateTime(new Date());
  showToast('‚è∞ Heure mise √† jour');
}
function updateSymptomTime() {
  document.getElementById('symptomDateTime').textContent = formatDateTime(new Date());
  showToast('‚è∞ Heure mise √† jour');
}

/* Photo handling */
function handlePhoto(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    document.getElementById('previewImg').src = e.target.result;
    document.getElementById('photoPreview').style.display = 'block';
    document.getElementById('photoZone').style.display = 'none';
    analyzePhotoWithAI(e.target.result);
  };
  reader.readAsDataURL(file);
}

function resetPhoto() {
  document.getElementById('photoPreview').style.display = 'none';
  document.getElementById('photoZone').style.display = 'block';
  document.getElementById('aiAnalysis').style.display = 'none';
  document.getElementById('fileInput').value = '';
}

// Store last photo data for re-analysis
let _lastPhotoBase64 = null;

function reanalyzePhoto() {
  if (_lastPhotoBase64) {
    document.getElementById('ingredientChips').innerHTML = '';
    document.getElementById('aiAnalysis').style.display = 'none';
    analyzePhotoWithAI(_lastPhotoBase64);
  }
}

async function analyzePhotoWithAI(base64Data) {
  _lastPhotoBase64 = base64Data;
  document.getElementById('aiThinking').style.display = 'block';
  document.getElementById('aiAnalysis').style.display = 'none';

  const promptText = `Tu es un expert en vision culinaire et nutrition (SII/SIBO). Analyse cette photo de repas avec une rigueur absolue.

R√àGLES CRITIQUES ‚Äî √† respecter imp√©rativement :
1. Ne liste QUE les ingr√©dients que tu VOIS r√©ellement dans l'image. Z√©ro supposition, z√©ro compl√©tion probable.
2. Si un ingr√©dient est visible mais partiellement cach√© (ex: saumon sous des p√¢tes, l√©gumes enfouis), mets confidence=0.6 et visible=false.
3. Si tu vois clairement un ingr√©dient (ex: p√¢tes au premier plan), mets confidence=0.95 et visible=true.
4. Ne JAMAIS ajouter d'ingr√©dients typiques d'un plat (ex: ail, sauce tomate) si tu ne les vois pas ‚Äî m√™me s'ils sont courants dans cette recette.
5. Si l'image est floue ou l'ingr√©dient peu discernable, note-le dans ton raisonnement.

R√©ponds UNIQUEMENT en JSON valide, sans backticks ni commentaires :
{
  "ingredients": [
    {
      "name": "Nom exact en fran√ßais",
      "fodmap": "low|medium|high",
      "quantity": "estimation visuelle ex: ~200g",
      "confidence": 0.95,
      "visible": true,
      "reason": "Visible clairement / partiellement cach√© sous X / d√©duit de Y"
    }
  ],
  "fodmapScore": 0.30,
  "description": "Description neutre de ce que tu vois r√©ellement",
  "warning": "Alerte FODMAP si pertinente, sinon null",
  "reasoning": "1-2 phrases sur ce que tu as vu/pas vu et pourquoi tu as h√©sit√© sur certains ingr√©dients"
}

fodmapScore = nombre entre 0 (faible) et 1 (√©lev√©), bas√© uniquement sur les ingr√©dients visibles certains (confidence > 0.7).`;

  try {
    const imgData = base64Data.includes(',') ? base64Data.split(',')[1] : base64Data;
    // Detect mime type
    const mimeMatch = base64Data.match(/data:(image\/\w+);/);
    const mimeType = mimeMatch ? mimeMatch[1] : 'image/jpeg';

    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "claude-sonnet-4-5-20250929",
        max_tokens: 1200,
        messages: [{
          role: "user",
          content: [
            { type: "image", source: { type: "base64", media_type: mimeType, data: imgData } },
            { type: "text", text: promptText }
          ]
        }]
      })
    });

    const data = await response.json();
    if (data.error) throw new Error(data.error.message);

    const raw = data.content?.[0]?.text || '{}';
    const clean = raw.replace(/```json\s*|\s*```/g, '').trim();
    const result = JSON.parse(clean);
    renderAIAnalysis(result);
  } catch(err) {
    console.warn('AI analyse error:', err);
    // Fallback: empty result, prompt user to fill manually
    renderAIAnalysis({
      ingredients: [],
      fodmapScore: 0.3,
      description: '',
      warning: null,
      reasoning: 'Analyse automatique indisponible. Veuillez saisir les ingr√©dients manuellement ci-dessous.'
    });
    showToast('‚ö†Ô∏è Analyse IA indisponible ‚Äî saisie manuelle', 4000);
  } finally {
    document.getElementById('aiThinking').style.display = 'none';
  }
}

function renderAIAnalysis(result) {
  AppState.analysisIngredients = result.ingredients || [];

  const chipsEl = document.getElementById('ingredientChips');

  if (AppState.analysisIngredients.length === 0) {
    chipsEl.innerHTML = `<div style="font-size:.8rem; color:var(--slate-soft); padding:4px 0; font-style:italic;">
      Aucun ingr√©dient identifi√© avec certitude. Ajoutez-les manuellement ‚Üì
    </div>`;
  } else {
    chipsEl.innerHTML = AppState.analysisIngredients.map((ing, i) => {
      const conf = ing.confidence ?? 0.9;
      const isUncertain = conf < 0.75 || ing.visible === false;

      // Color based on FODMAP + certainty
      let chipCls, icon;
      if (ing.fodmap === 'high') {
        chipCls = 'chip-warning';
        icon = '‚ö†Ô∏è';
      } else if (isUncertain) {
        chipCls = 'chip-neutral';
        icon = '‚ùì';
      } else {
        chipCls = 'chip-validated';
        icon = '‚úì';
      }

      const confPct = Math.round(conf * 100);
      const confColor = conf >= 0.85 ? 'var(--sage)' : conf >= 0.65 ? 'var(--amber)' : 'var(--coral)';
      const title = ing.reason || '';
      const uncertainStyle = isUncertain ? 'opacity:.75; border-style:dashed;' : '';

      return `<div class="chip ${chipCls}" style="${uncertainStyle}" onclick="toggleIngredient(${i}, this)" title="${title}">
        ${icon} ${ing.name}
        <span style="font-size:.65rem; color:${confColor}; font-weight:700; margin-left:2px;">${confPct}%</span>
        ${ing.quantity ? `<span style="opacity:.5; font-size:.7rem">${ing.quantity}</span>` : ''}
        ${isUncertain ? `<span style="font-size:.62rem; color:var(--amber); margin-left:2px;">suppos√©</span>` : ''}
      </div>`;
    }).join('');
  }

  // Show AI reasoning
  if (result.reasoning) {
    document.getElementById('aiReasoning').textContent = 'üí≠ ' + result.reasoning;
  }

  // Auto-fill description if empty
  if (result.description && !document.getElementById('mealDesc').value) {
    document.getElementById('mealDesc').value = result.description;
  }

  // FODMAP score: only count high-confidence ingredients
  const certifiedIngredients = AppState.analysisIngredients.filter(i => (i.confidence ?? 0.9) >= 0.7);
  const rawScore = result.fodmapScore || 0.3;
  const adjustedScore = certifiedIngredients.length < AppState.analysisIngredients.length
    ? rawScore * 0.85 // reduce score when uncertain about some ingredients
    : rawScore;
  const score = Math.max(0.05, Math.min(0.95, adjustedScore));
  document.getElementById('fodmapCursor').style.left = (score * 100) + '%';

  document.getElementById('aiAnalysis').style.display = 'block';

  // Warnings
  const uncertainCount = AppState.analysisIngredients.filter(i => (i.confidence ?? 0.9) < 0.75).length;
  if (uncertainCount > 0) {
    showToast(`‚ùì ${uncertainCount} ingr√©dient(s) suppos√©(s) ‚Äî √† v√©rifier`, 4500);
  } else if (result.warning) {
    showToast('‚ö†Ô∏è ' + result.warning, 4000);
  }
}

function toggleIngredient(idx, el) {
  const ing = AppState.analysisIngredients[idx];
  if (!ing) return;
  ing._removed = !ing._removed;
  el.style.opacity = ing._removed ? '0.4' : '1';
  el.style.textDecoration = ing._removed ? 'line-through' : 'none';
}

function addManualIngredient() {
  const input = document.getElementById('manualIngredient');
  const val = input.value.trim();
  if (!val) return;

  AppState.manualIngredients.push(val);
  renderManualChips();
  input.value = '';
}

function removeManualIngredient(idx) {
  AppState.manualIngredients.splice(idx, 1);
  renderManualChips();
}

function renderManualChips() {
  document.getElementById('manualChips').innerHTML = AppState.manualIngredients.map((ing, i) =>
    `<div class="chip chip-neutral">${ing} <span onclick="removeManualIngredient(${i})" style="margin-left:4px;cursor:pointer;opacity:.6">‚úï</span></div>`
  ).join('');
}

function saveMeal() {
  const desc = document.getElementById('mealDesc').value.trim();
  if (!desc && AppState.manualIngredients.length === 0 && AppState.analysisIngredients.length === 0) {
    showToast('‚ö†Ô∏è D√©crivez le repas ou ajoutez des ingr√©dients');
    return;
  }

  const allIngredients = [
    ...AppState.analysisIngredients.filter(i => !i._removed).map(i => i.name),
    ...AppState.manualIngredients
  ];

  AppState.addMeal({
    description: desc || allIngredients.join(', '),
    mealType:    document.getElementById('mealType').value,
    quantity:    document.getElementById('mealQty').value,
    unit:        document.getElementById('mealUnit').value,
    ingredients: allIngredients,
    hasPhoto:    document.getElementById('photoPreview').style.display !== 'none'
  });

  showToast('‚úÖ Repas enregistr√© !');
  setTimeout(() => navigate('dashboard'), 1200);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   SymptomComponent
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const SymptomComponent = {
  symptoms: ['douleur','ballon','gaz','eructation','nausee','cephale'],
  onInit() {
    document.getElementById('symptomDateTime').textContent = formatDateTime(new Date());
    AppState.currentSymptomScores = {};
    AppState.currentBristol = null;
    AppState.currentContexts = [];

    this.symptoms.forEach(key => {
      const el = document.getElementById('sr-' + key);
      el.innerHTML = '';
      for (let i = 0; i <= 10; i++) {
        const btn = document.createElement('button');
        btn.className = 'score-btn';
        btn.textContent = i;
        btn.onclick = () => this.selectScore(key, i, btn);
        el.appendChild(btn);
      }
    });

    // Bristol scale
    const bristolData = [
      {num:1, desc:'Grains durs'},
      {num:2, desc:'Grumeleux'},
      {num:3, desc:'Craquel√©'},
      {num:4, desc:'Lisse'},
      {num:5, desc:'Morceaux mous'},
      {num:6, desc:'P√¢teux'},
      {num:7, desc:'Liquide'}
    ];
    const row = document.getElementById('bristolRow');
    row.innerHTML = bristolData.map(b => `
      <div class="bristol-btn" onclick="selectBristol(${b.num}, this)">
        <div class="bristol-num">${b.num}</div>
        <div class="bristol-desc">${b.desc}</div>
      </div>
    `).join('');

    // Reset contexts
    document.querySelectorAll('[id^="ctx-"]').forEach(b => {
      b.style.borderColor = 'var(--border)';
      b.style.color = 'var(--slate-mid)';
      b.style.background = 'transparent';
    });
  },
  selectScore(key, val, btn) {
    AppState.currentSymptomScores[key] = val;
    const parentEl = document.getElementById('sr-' + key);
    parentEl.querySelectorAll('.score-btn').forEach(b => {
      b.classList.remove('selected','sel-amber','sel-coral');
    });
    const cls = scoreColor(val);
    btn.classList.add('selected');
    if (cls) btn.classList.add(cls);

    const card = document.getElementById('sc-' + key);
    if (val > 0) card.classList.add('active-card');
    else card.classList.remove('active-card');
  }
};

function selectBristol(num, el) {
  AppState.currentBristol = num;
  document.querySelectorAll('.bristol-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
}

function toggleContext(key) {
  const btn = document.getElementById('ctx-' + key);
  const idx = AppState.currentContexts.indexOf(key);
  if (idx >= 0) {
    AppState.currentContexts.splice(idx, 1);
    btn.style.borderColor = 'var(--border)';
    btn.style.color = 'var(--slate-mid)';
    btn.style.background = 'transparent';
  } else {
    AppState.currentContexts.push(key);
    btn.style.borderColor = 'var(--sage)';
    btn.style.color = 'var(--sage)';
    btn.style.background = 'var(--sage-faint)';
  }
}

function saveSymptoms() {
  const hasAnySymptom = Object.values(AppState.currentSymptomScores).some(v => v > 0)
    || AppState.currentBristol !== null;

  AppState.addSymptom({
    scores:   { ...AppState.currentSymptomScores },
    bristol:  AppState.currentBristol,
    contexts: [...AppState.currentContexts],
    notes:    document.getElementById('symptomNotes').value.trim()
  });

  showToast('‚úÖ Sympt√¥mes enregistr√©s !');
  document.getElementById('symptomNotes').value = '';
  setTimeout(() => navigate('dashboard'), 1200);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   HistoryComponent
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const HistoryComponent = {
  currentFilter: 'all',
  onInit() {
    this.render('all');
  },
  render(filter) {
    this.currentFilter = filter;
    let all = [
      ...AppState.meals.map(m => ({...m, kind:'meal'})),
      ...AppState.symptoms.map(s => ({...s, kind:'symptom'}))
    ].sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

    if (filter === 'meal')    all = all.filter(e => e.kind === 'meal');
    if (filter === 'symptom') all = all.filter(e => e.kind === 'symptom');

    const container = document.getElementById('historyContent');

    if (all.length === 0) {
      container.innerHTML = `<div style="text-align:center;padding:40px 20px;color:var(--slate-soft);">
        <div style="font-size:40px;margin-bottom:12px;">üì≠</div>
        <div>Aucune entr√©e pour le moment.</div>
        <div style="font-size:.8rem;margin-top:6px;">Commencez par enregistrer un repas ou des sympt√¥mes.</div>
      </div>`;
      return;
    }

    // Group by date
    const byDate = {};
    all.forEach(e => {
      const key = new Date(e.createdAt).toDateString();
      if (!byDate[key]) byDate[key] = [];
      byDate[key].push(e);
    });

    container.innerHTML = Object.entries(byDate).map(([dateStr, entries]) => {
      const date = new Date(dateStr);
      const label = date.toDateString() === new Date().toDateString()
        ? "Aujourd'hui"
        : date.toLocaleDateString('fr-FR', { weekday:'long', day:'numeric', month:'long' });

      return `<div class="day-group">
        <div class="day-label">${label}</div>
        ${entries.map(e => this.renderEntry(e)).join('')}
      </div>`;
    }).join('');
  },
  renderEntry(e) {
    if (e.kind === 'meal') {
      const ings = (e.ingredients || []).slice(0,4).map(i =>
        `<span class="pill pill-sage" style="font-size:.68rem">${i}</span>`
      ).join('');
      return `<div class="history-entry">
        <div class="entry-icon-wrap ei-meal">üç¥</div>
        <div class="entry-body">
          <div class="entry-time">${formatTime(new Date(e.createdAt))} ¬∑ ${e.mealType || 'Repas'} ${e.hasPhoto ? '¬∑ üì∏' : ''}</div>
          <div class="entry-title">${e.description?.substring(0,50) || 'Repas enregistr√©'}${e.description?.length > 50 ? '‚Ä¶' : ''}</div>
          <div class="entry-pills mt-8">${ings}</div>
          ${e.quantity ? `<div class="entry-detail">${e.quantity} ${e.unit}</div>` : ''}
        </div>
      </div>`;
    } else {
      const syms = Object.entries(e.scores || {})
        .filter(([,v]) => v > 0)
        .map(([k,v]) => {
          const cl = v >= 7 ? 'pill-coral' : v >= 4 ? 'pill-amber' : 'pill-sage';
          const name = {douleur:'Douleur',ballon:'Ballonnement',gaz:'Gaz',eructation:'√âructation',nausee:'Naus√©e',cephale:'C√©phal√©e'}[k] || k;
          return `<span class="pill ${cl}" style="font-size:.68rem">${name} ${v}/10</span>`;
        }).join('');
      const bristol = e.bristol ? `<span class="pill pill-sage" style="font-size:.68rem">Bristol ${e.bristol}</span>` : '';
      return `<div class="history-entry">
        <div class="entry-icon-wrap ei-symptom">üíä</div>
        <div class="entry-body">
          <div class="entry-time">${formatTime(new Date(e.createdAt))}</div>
          <div class="entry-title">Sympt√¥mes signal√©s</div>
          <div class="entry-pills mt-8">${syms || '<span style="font-size:.78rem;color:var(--slate-soft)">Aucun sympt√¥me majeur</span>'}${bristol}</div>
          ${e.notes ? `<div class="entry-detail">${e.notes.substring(0,60)}‚Ä¶</div>` : ''}
        </div>
      </div>`;
    }
  }
};

function filterHistory(type, btn) {
  document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  HistoryComponent.render(type);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   SyntheseComponent
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const SyntheseComponent = {
  onInit() {
    this.renderHeatmap();
  },
  renderHeatmap() {
    const hm = document.getElementById('heatmap');
    const levels = [0,1,2,4,1,0,2, 3,1,0,1,2,1,0, 0,2,3,4,1,0,2, 1,0,0,1,2,0,1];
    hm.innerHTML = levels.map((l, i) =>
      `<div class="hm-day hm-${l}" style="font-size:.6rem">${i+1}</div>`
    ).join('');
  }
};

function selectPeriod(days, btn) {
  document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  showToast(`üìä Affichage sur ${days} jours`);
}

function exportPDF() {
  showToast('üìÑ Rapport PDF en cours de g√©n√©ration‚Ä¶', 3000);
  setTimeout(() => showToast('‚úÖ Rapport g√©n√©r√© et pr√™t !'), 3500);
}
function exportCSV() {
  const meals = AppState.meals;
  const rows = [['Date','Heure','Type','Description','Ingr√©dients','Quantit√©','Unit√©']];
  meals.forEach(m => {
    const d = new Date(m.createdAt);
    rows.push([
      d.toLocaleDateString('fr-FR'),
      d.toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit'}),
      m.mealType, m.description,
      (m.ingredients||[]).join(' | '),
      m.quantity, m.unit
    ]);
  });
  const csv = rows.map(r => r.map(c => `"${(c||'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = `guttrack-export-${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  showToast('üìä CSV export√© !');
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   AI Chat Modal
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function openAiChat() {
  document.getElementById('aiChatModal').classList.add('open');
}
function closeModal(event) {
  if (event.target === document.getElementById('aiChatModal')) {
    document.getElementById('aiChatModal').classList.remove('open');
  }
}
function prefillChat(text) {
  document.getElementById('chatInput').value = text;
  document.getElementById('chatInput').focus();
}

async function sendAiMessage() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg) return;

  const area = document.getElementById('chatArea');
  input.value = '';

  area.innerHTML += `<div class="chat-bubble chat-bubble-user">${msg}</div>`;
  area.innerHTML += `<div class="chat-thinking" id="thinking"><div class="chat-dot"></div><div class="chat-dot"></div><div class="chat-dot"></div></div>`;
  area.scrollTop = area.scrollHeight;

  // Build context from user data
  const context = buildAIContext();

  try {
    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "claude-sonnet-4-5-20250929",
        max_tokens: 1000,
        messages: [{
          role: "user",
          content: `Tu es GutTrack AI, un assistant expert en sant√© digestive sp√©cialis√© dans le SII (syndrome de l'intestin irritable) et le SIBO. Tu r√©ponds en fran√ßais, de mani√®re empathique et pr√©cise.

Donn√©es du journal de l'utilisateur :
${context}

Question de l'utilisateur : ${msg}

R√©ponds de mani√®re utile, concise (3-4 phrases max), et pratique. Rappelle que tu ne remplaces pas un m√©decin pour un diagnostic formel.`
        }]
      })
    });

    const data = await response.json();
    const reply = data.content?.[0]?.text || "Je n'ai pas pu analyser votre question. R√©essayez.";

    document.getElementById('thinking')?.remove();
    area.innerHTML += `<div class="chat-bubble">${reply}</div>`;
  } catch(err) {
    document.getElementById('thinking')?.remove();
    area.innerHTML += `<div class="chat-bubble">Je suis temporairement indisponible. V√©rifiez votre connexion et r√©essayez.</div>`;
  }

  area.scrollTop = area.scrollHeight;
}

function buildAIContext() {
  const mealCount = AppState.meals.length;
  const symCount  = AppState.symptoms.length;
  const lastMeals = AppState.meals.slice(0,5).map(m =>
    `- ${new Date(m.createdAt).toLocaleDateString('fr-FR')}: ${m.description} (${(m.ingredients||[]).join(', ')})`
  ).join('\n');
  const lastSyms = AppState.symptoms.slice(0,5).map(s => {
    const syms = Object.entries(s.scores||{}).filter(([,v])=>v>0).map(([k,v])=>`${k}:${v}/10`).join(', ');
    return `- ${new Date(s.createdAt).toLocaleDateString('fr-FR')}: ${syms || 'aucun sympt√¥me'}`;
  }).join('\n');

  return `Repas enregistr√©s: ${mealCount}
Sympt√¥mes enregistr√©s: ${symCount}
Derniers repas:\n${lastMeals || 'Aucun repas enregistr√©'}
Derniers sympt√¥mes:\n${lastSyms || 'Aucun sympt√¥me enregistr√©'}`;
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   Bootstrap
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
document.addEventListener('DOMContentLoaded', () => {
  // Enter key on chat
  document.getElementById('chatInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') sendAiMessage();
  });
  // Enter key on manual ingredient
  document.getElementById('manualIngredient').addEventListener('keydown', e => {
    if (e.key === 'Enter') addManualIngredient();
  });

  DashboardComponent.onInit();
});
</script>
</body>
</html>
