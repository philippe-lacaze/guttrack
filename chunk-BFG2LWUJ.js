import{a as Ce,b as be}from"./chunk-UB6VBAEX.js";import{a as re,b as ae,c as le,d as se,e as me,f as pe,g as de,h as ce,i as ue,j as ge,l as fe,n as _e}from"./chunk-QBKVUF7L.js";import{a as ye}from"./chunk-AUGRQXUW.js";import{a as oe}from"./chunk-WKM2OYV4.js";import{a as ee}from"./chunk-RL5KOLBU.js";import{a as te,d as ne,f as ie}from"./chunk-PK5YRH4Z.js";import{a as Z}from"./chunk-Q7Y4YLXA.js";import{c as X}from"./chunk-EGESI55J.js";import"./chunk-YOOGVOXO.js";import{$a as v,Da as P,Db as F,Eb as Q,M as I,Oa as _,Pa as y,Qa as B,R as f,Ra as W,Sa as E,Ta as A,Ua as h,Va as s,W as u,Wa as m,X as g,Xa as $,Ya as p,Za as c,_a as L,ab as H,bb as x,ca as b,cb as w,db as d,jb as q,lb as G,mb as Y,nb as a,oa as U,ob as T,pb as N,qa as r,qb as J,rb as S,sb as O,tb as k,ub as K}from"./chunk-LQHLUY7B.js";import{c as C}from"./chunk-2VMXMS7J.js";function he(i,t){if(i&1){let e=v();p(0,"div",3),L(1,"img",5),p(2,"button",6),w("click",function(){u(e);let o=d();return g(o.remove())}),a(3,"\u2715 Supprimer"),c()()}if(i&2){let e=d();r(),H("src",e.preview(),U)}}function ve(i,t){if(i&1){let e=v();p(0,"div",7),w("click",function(){u(e);let o=q(9);return g(o.click())}),p(1,"span"),a(2,"\u{1F4F7}"),c(),p(3,"p"),a(4,"Prendre une photo"),L(5,"br"),p(6,"small"),a(7,"ou galerie"),c()(),p(8,"input",8,0),w("change",function(o){u(e);let l=d();return g(l.onFile(o))}),c()()}}var V=class i{photoSelected=F();preview=b(null);onFile(t){return C(this,null,function*(){let e=t.target.files?.[0];e&&(this.preview.set(URL.createObjectURL(e)),this.photoSelected.emit(e))})}remove(){this.preview.set(null),this.photoSelected.emit(null)}static \u0275fac=function(e){return new(e||i)};static \u0275cmp=P({type:i,selectors:[["app-photo-upload"]],outputs:{photoSelected:"photoSelected"},decls:5,vars:1,consts:[["input",""],[1,"wrap"],[1,"lbl"],[1,"prev"],[1,"area"],["alt","Aper\xE7u",1,"img",3,"src"],["type","button",1,"rm",3,"click"],[1,"area",3,"click"],["type","file","accept","image/*","capture","environment",2,"display","none",3,"change"]],template:function(e,n){e&1&&(p(0,"div",1)(1,"label",2),a(2,"Photo du repas (optionnel)"),c(),_(3,he,4,1,"div",3)(4,ve,10,0,"div",4),c()),e&2&&(r(3),y(n.preview()?3:4))},styles:[".wrap[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.4rem}.lbl[_ngcontent-%COMP%]{font-size:.85rem;font-weight:600;color:#666}.area[_ngcontent-%COMP%]{border:2px dashed #ccc;border-radius:12px;padding:2rem;text-align:center;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:.5rem}.area[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{font-size:2rem}.area[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:#888;font-size:.85rem;margin:0}.prev[_ngcontent-%COMP%]{position:relative}.img[_ngcontent-%COMP%]{width:100%;max-height:200px;object-fit:cover;border-radius:12px}.rm[_ngcontent-%COMP%]{position:absolute;top:.5rem;right:.5rem;background:#00000080;color:#fff;border:none;border-radius:20px;padding:.3rem .75rem;font-size:.8rem;cursor:pointer}"]})};var we=(i,t)=>t.name;function Pe(i,t){if(i&1&&(p(0,"span",10),a(1),c()),i&2){let e=d().$implicit;r(),T(e.category)}}function Ee(i,t){if(i&1&&(p(0,"div",3)(1,"div",8)(2,"span",9),a(3),c(),p(4,"span"),a(5),c()(),_(6,Pe,2,1,"span",10),c()),i&2){let e=t.$implicit;r(3),T(e.name),r(),Y(K("fb fb--",e.fodmapLevel??"unknown")),r(),N("FODMAP ",e.fodmapLevel??"?"),r(),y(e.category?6:-1)}}function Ae(i,t){if(i&1&&(p(0,"p",4),a(1),c()),i&2){let e=d();r(),T(e.result().notes)}}var R=class i{result=Q.required();accepted=F();rejected=F();static \u0275fac=function(e){return new(e||i)};static \u0275cmp=P({type:i,selectors:[["app-ai-analysis-review"]],inputs:{result:[1,"result"]},outputs:{accepted:"accepted",rejected:"rejected"},decls:12,vars:2,consts:[[1,"box"],[1,"title"],[1,"list"],[1,"item"],[1,"notes"],[1,"actions"],["type","button",1,"sec",3,"click"],["type","button",1,"pri",3,"click"],[1,"ih"],[1,"name"],[1,"cat"]],template:function(e,n){e&1&&(p(0,"div",0)(1,"h3",1),a(2),c(),p(3,"div",2),E(4,Ee,7,6,"div",3,we),c(),_(6,Ae,2,1,"p",4),p(7,"div",5)(8,"button",6),w("click",function(){return n.rejected.emit()}),a(9,"Ignorer"),c(),p(10,"button",7),w("click",function(){return n.accepted.emit(n.result())}),a(11,"Utiliser"),c()()()),e&2&&(r(2),N("\u{1F916} Analyse IA \u2014 Confiance ",(n.result().confidence*100).toFixed(0),"%"),r(2),A(n.result().ingredients),r(2),y(n.result().notes?6:-1))},styles:[".box[_ngcontent-%COMP%]{background:#f3e5f5;border-radius:12px;padding:1rem}.title[_ngcontent-%COMP%]{font-size:1rem;font-weight:700;margin:0 0 .75rem;color:#6a1b9a}.list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.4rem;margin-bottom:.75rem}.item[_ngcontent-%COMP%]{background:#fff;border-radius:8px;padding:.6rem}.ih[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center}.name[_ngcontent-%COMP%]{font-weight:600;font-size:.9rem}.fb[_ngcontent-%COMP%]{font-size:.7rem;padding:.2rem .5rem;border-radius:10px;font-weight:600}.fb--low[_ngcontent-%COMP%]{background:#e8f5e9;color:#2e7d32}.fb--medium[_ngcontent-%COMP%]{background:#fff8e1;color:#f57f17}.fb--high[_ngcontent-%COMP%]{background:#ffebee;color:#c62828}.fb--unknown[_ngcontent-%COMP%]{background:#f5f5f5;color:#757575}.cat[_ngcontent-%COMP%]{font-size:.75rem;color:#888;display:block;margin-top:.2rem}.notes[_ngcontent-%COMP%]{font-size:.8rem;color:#666;font-style:italic;margin:.5rem 0 0}.actions[_ngcontent-%COMP%]{display:flex;gap:.5rem;margin-top:1rem}.pri[_ngcontent-%COMP%]{flex:2;padding:.75rem;border-radius:10px;border:none;background:#7b1fa2;color:#fff;font-weight:600;cursor:pointer}.sec[_ngcontent-%COMP%]{flex:1;padding:.75rem;border-radius:10px;border:1px solid #ccc;background:#fff;cursor:pointer}"]})};var D=class i{repo=f(te);execute(t){return C(this,null,function*(){let e={id:ye(),timestamp:oe(t.timestampMs),mealType:t.mealType,ingredients:t.ingredients.map(n=>({ingredient:Ce(n.name,n.category,n.fodmapLevel),portion:be(n.portionAmount,n.portionUnit)})),notes:t.notes,aiAnalyzed:!1};return yield this.repo.save(e),{id:e.id,timestamp:e.timestamp,mealType:e.mealType,ingredients:t.ingredients,notes:e.notes,aiAnalyzed:e.aiAnalyzed}})}static \u0275fac=function(e){return new(e||i)};static \u0275prov=I({token:i,factory:i.\u0275fac,providedIn:"root"})};var j=class i{settings=f(ie);aiVision=f(ne);execute(t){return C(this,null,function*(){if(this.settings.getSettings().aiProvider==="none")throw new Error("Aucun provider IA configur\xE9. Veuillez configurer une cl\xE9 API dans les param\xE8tres.");let n=yield this.blobToBase64(t.photoBlob),o=t.photoBlob.type||"image/jpeg";return this.aiVision.analyzeImage(n,o,`Analyse cette photo de repas et identifie tous les aliments visibles.
Pour chaque aliment, fournis le nom, la cat\xE9gorie, une estimation de la portion et le niveau FODMAP (low/medium/high/unknown).
R\xE9ponds en JSON structur\xE9.`)})}blobToBase64(t){return new Promise((e,n)=>{let o=new FileReader;o.onload=()=>e(o.result.split(",")[1]),o.onerror=n,o.readAsDataURL(t)})}static \u0275fac=function(e){return new(e||i)};static \u0275prov=I({token:i,factory:i.\u0275fac,providedIn:"root"})};var Te=(i,t)=>t.v;function Se(i,t){if(i&1){let e=v();s(0,"button",21),x("click",function(){let o=u(e).$implicit,l=d();return g(l.mealType.set(o.v))}),a(1),m()}if(i&2){let e=t.$implicit,n=d();G("sel",n.mealType()===e.v),r(),J("",e.icon," ",e.label)}}function Oe(i,t){i&1&&$(0,"app-loading-spinner",9)}function ke(i,t){if(i&1){let e=v();s(0,"app-ai-analysis-review",22),x("accepted",function(o){u(e);let l=d();return g(l.applyAi(o))})("rejected",function(){u(e);let o=d();return g(o.aiResult.set(null))}),m()}if(i&2){let e=d();h("result",e.aiResult())}}function Fe(i,t){if(i&1&&(s(0,"option",26),a(1),m()),i&2){let e=t.$implicit;h("value",e),r(),T(e)}}function Ie(i,t){if(i&1){let e=v();s(0,"div",14)(1,"input",23),k("ngModelChange",function(o){let l=u(e).$index,M=d();return O(M.ings()[l].name,o)||(M.ings()[l].name=o),g(o)}),m(),s(2,"input",24),k("ngModelChange",function(o){let l=u(e).$index,M=d();return O(M.ings()[l].portionAmount,o)||(M.ings()[l].portionAmount=o),g(o)}),m(),s(3,"select",25),k("ngModelChange",function(o){let l=u(e).$index,M=d();return O(M.ings()[l].portionUnit,o)||(M.ings()[l].portionUnit=o),g(o)}),E(4,Fe,2,2,"option",26,W),m(),s(6,"button",27),x("click",function(){let o=u(e).$index,l=d();return g(l.rmIng(o))}),a(7,"\u2715"),m()()}if(i&2){let e=t.$index,n=d();r(),S("ngModel",n.ings()[e].name),h("name","n"+e),r(),S("ngModel",n.ings()[e].portionAmount),h("name","a"+e),r(),S("ngModel",n.ings()[e].portionUnit),h("name","u"+e),r(),A(n.units)}}function Ve(i,t){i&1&&(s(0,"p",15),a(1,"Ajoutez des ingr\xE9dients manuellement ou via une photo IA."),m())}function ze(i,t){i&1&&a(0,"Enregistrement...")}function Re(i,t){i&1&&a(0,"Enregistrer le repas")}var Me=class i{logMeal=f(D);analyzePhoto=f(j);router=f(X);toast=f(Z);mealTypes=[{v:"breakfast",icon:"\u{1F305}",label:"Petit-d\xE9j"},{v:"lunch",icon:"\u2600\uFE0F",label:"D\xE9jeuner"},{v:"dinner",icon:"\u{1F319}",label:"D\xEEner"},{v:"snack",icon:"\u{1F34E}",label:"Collation"}];units=["g","ml","cup","tbsp","tsp","piece","serving"];mealType=b("lunch");ings=b([]);analyzing=b(!1);aiResult=b(null);submitting=b(!1);dt=b(this.nowLocal());notes="";onPhoto(t){return C(this,null,function*(){if(this.aiResult.set(null),!!t){this.analyzing.set(!0);try{this.aiResult.set(yield this.analyzePhoto.execute({photoBlob:t}))}catch(e){e.message?.includes("configur\xE9")?this.toast.info("Photo ajout\xE9e. Configurez une cl\xE9 API pour l'analyse IA."):this.toast.error("Erreur IA: "+(e.message??"Inconnue"))}finally{this.analyzing.set(!1)}}})}applyAi(t){this.ings.set(t.ingredients.map(e=>({name:e.name,category:e.category??"",fodmapLevel:e.fodmapLevel??"unknown",portionAmount:1,portionUnit:"serving"}))),this.aiResult.set(null),this.toast.success("Ingr\xE9dients import\xE9s depuis l'IA")}addIng(){this.ings.update(t=>[...t,{name:"",category:"",fodmapLevel:"unknown",portionAmount:1,portionUnit:"serving"}])}rmIng(t){this.ings.update(e=>e.filter((n,o)=>o!==t))}back(){this.router.navigate(["/food-journal"])}submit(){return C(this,null,function*(){if(!this.submitting()){if(this.ings().some(t=>!t.name.trim())){this.toast.error("Tous les ingr\xE9dients doivent avoir un nom");return}this.submitting.set(!0);try{yield this.logMeal.execute({mealType:this.mealType(),ingredients:this.ings().map(t=>({name:t.name.trim(),category:t.category||void 0,fodmapLevel:t.fodmapLevel,portionAmount:t.portionAmount,portionUnit:t.portionUnit})),notes:this.notes||void 0,timestampMs:new Date(this.dt()).getTime()}),this.toast.success("Repas enregistr\xE9"),this.router.navigate(["/food-journal"])}catch{this.toast.error("Erreur lors de l'enregistrement")}finally{this.submitting.set(!1)}}})}nowLocal(){let t=new Date;return t.setMinutes(t.getMinutes()-t.getTimezoneOffset()),t.toISOString().slice(0,16)}static \u0275fac=function(e){return new(e||i)};static \u0275cmp=P({type:i,selectors:[["app-meal-form"]],decls:36,vars:7,consts:[[1,"page"],[1,"ph"],[1,"back",3,"click"],[1,"form",3,"ngSubmit"],[1,"field"],[1,"fl"],[1,"mtype"],["type","button",1,"mt-btn",3,"sel"],[3,"photoSelected"],["message","Analyse IA..."],[3,"result"],[1,"ings"],[1,"ings-hdr"],["type","button",1,"add-ing",3,"click"],[1,"ing-row"],[1,"no-ing"],["for","mdt",1,"fl"],["id","mdt","type","datetime-local","name","dt",1,"fi",3,"ngModelChange","ngModel"],["for","mn",1,"fl"],["id","mn","name","notes","rows","3","placeholder","Humeur, contexte...",1,"fi","fi-ta",3,"ngModelChange","ngModel"],["type","submit",1,"btn-primary",3,"disabled"],["type","button",1,"mt-btn",3,"click"],[3,"accepted","rejected","result"],["placeholder","Ingr\xE9dient",1,"fi",3,"ngModelChange","ngModel","name"],["type","number","min","0.1","step","0.1",1,"fi","pa",3,"ngModelChange","ngModel","name"],[1,"fi","pu",3,"ngModelChange","ngModel","name"],[3,"value"],["type","button",1,"rm",3,"click"]],template:function(e,n){e&1&&(s(0,"div",0)(1,"header",1)(2,"button",2),x("click",function(){return n.back()}),a(3,"\u2190 Retour"),m(),s(4,"h1"),a(5,"Enregistrer un repas"),m()(),s(6,"form",3),x("ngSubmit",function(){return n.submit()}),s(7,"div",4)(8,"label",5),a(9,"Type de repas"),m(),s(10,"div",6),E(11,Se,2,4,"button",7,Te),m()(),s(13,"app-photo-upload",8),x("photoSelected",function(l){return n.onPhoto(l)}),m(),_(14,Oe,1,0,"app-loading-spinner",9),_(15,ke,1,1,"app-ai-analysis-review",10),s(16,"div",11)(17,"div",12)(18,"label",5),a(19,"Ingr\xE9dients"),m(),s(20,"button",13),x("click",function(){return n.addIng()}),a(21,"+ Ajouter"),m()(),E(22,Ie,8,6,"div",14,B),_(24,Ve,2,0,"p",15),m(),s(25,"div",4)(26,"label",16),a(27,"Date et heure"),m(),s(28,"input",17),x("ngModelChange",function(l){return n.dt.set(l)}),m()(),s(29,"div",4)(30,"label",18),a(31,"Notes"),m(),s(32,"textarea",19),k("ngModelChange",function(l){return O(n.notes,l)||(n.notes=l),l}),m()(),s(33,"button",20),_(34,ze,1,0)(35,Re,1,0),m()()()),e&2&&(r(11),A(n.mealTypes),r(3),y(n.analyzing()?14:-1),r(),y(n.aiResult()?15:-1),r(7),A(n.ings()),r(2),y(n.ings().length?-1:24),r(4),h("ngModel",n.dt()),r(4),S("ngModel",n.notes),r(),h("disabled",n.submitting()),r(),y(n.submitting()?34:35))},dependencies:[_e,pe,ue,ge,re,de,ce,ae,le,fe,me,se,V,R,ee],styles:[".page[_ngcontent-%COMP%]{padding:1rem;max-width:600px;margin:0 auto}.ph[_ngcontent-%COMP%]{margin-bottom:1.5rem}.ph[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{font-size:1.3rem;font-weight:700;margin:.5rem 0 0}.back[_ngcontent-%COMP%]{background:none;border:none;color:#2e7d32;cursor:pointer;font-size:.9rem;padding:0}.form[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1.25rem}.field[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.4rem}.fl[_ngcontent-%COMP%]{font-size:.85rem;font-weight:600;color:#666}.fi[_ngcontent-%COMP%]{padding:.75rem;border:1.5px solid #ddd;border-radius:10px;font-size:.95rem;width:100%;box-sizing:border-box}.fi-ta[_ngcontent-%COMP%]{resize:vertical;min-height:80px;font-family:inherit}.mtype[_ngcontent-%COMP%]{display:flex;gap:.5rem;flex-wrap:wrap}.mt-btn[_ngcontent-%COMP%]{padding:.5rem 1rem;border-radius:20px;border:1.5px solid #ddd;background:#fff;cursor:pointer;font-size:.85rem}.mt-btn.sel[_ngcontent-%COMP%]{background:#e8f5e9;border-color:#2e7d32;color:#2e7d32;font-weight:600}.ings[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.5rem}.ings-hdr[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center}.add-ing[_ngcontent-%COMP%]{background:none;border:1px solid #2e7d32;color:#2e7d32;padding:.3rem .75rem;border-radius:20px;cursor:pointer;font-size:.8rem}.ing-row[_ngcontent-%COMP%]{display:flex;gap:.4rem;align-items:center;flex-wrap:wrap;background:#f9f9f9;padding:.5rem;border-radius:8px}.ing-row[_ngcontent-%COMP%]   .fi[_ngcontent-%COMP%]{flex:1;min-width:100px;padding:.5rem}.pa[_ngcontent-%COMP%]{width:70px!important;flex:none!important}.pu[_ngcontent-%COMP%]{width:80px!important;flex:none!important}.rm[_ngcontent-%COMP%]{background:none;border:none;color:#bdbdbd;cursor:pointer;font-size:1.1rem;padding:.25rem;flex-shrink:0}.no-ing[_ngcontent-%COMP%]{font-size:.85rem;color:#888;font-style:italic;margin:0}.btn-primary[_ngcontent-%COMP%]{padding:1rem;border-radius:12px;border:none;background:#2e7d32;color:#fff;font-size:1rem;font-weight:600;cursor:pointer}.btn-primary[_ngcontent-%COMP%]:disabled{opacity:.6}"]})};export{Me as MealFormComponent};
